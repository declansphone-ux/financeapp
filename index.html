<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Budget Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* ============================================
           ENHANCED STYLES & CSS VARIABLE
           ============================================ */

            :root {
                --primary-blue: #60A5FA;
                --light-blue: #1E3A8A;
                --dark-blue: #93C5FD;
                --accent-blue: #3B82F6;
                --white: #1F2937;
                --light-gray: #374151;
                --medium-gray: #4B5563;
                --dark-gray: #D1D5DB; /* Changed from #9CA3AF for better contrast */
                --text-dark: #F9FAFB;
                --success: #34D399;
                --warning: #FBBF24;
                --danger: #F87171;
                --spacing-xs: 0.5rem;
                --spacing-sm: 1rem;
                --spacing-md: 1.5rem;
                --spacing-lg: 2rem;
                --spacing-xl: 3rem;
                --radius-sm: 6px;
                --radius-md: 10px;
                --radius-lg: 16px;
                --shadow-xs: 0 1px 2px rgba(0,0,0,0.3);
                --shadow-sm: 0 2px 4px rgba(0,0,0,0.4);
                --shadow-md: 0 4px 8px rgba(0,0,0,0.5);
                --shadow-lg: 0 10px 20px rgba(0,0,0,0.6);
                --shadow-xl: 0 20px 30px rgba(0,0,0,0.7);
                --bg-dark: #111827;
                --bg-darker: #0F172A;
                --card-bg: #1F2937;
                --card-bg-light: #374151;
            }

        * { margin:0; padding:0; box-sizing:border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-darker) 0%, var(--bg-dark) 100%);
            min-height:100vh; 
            color:var(--text-dark); 
            line-height:1.6;
        }
        
        .container { 
            max-width:1600px; 
            margin:0 auto; 
            padding:var(--spacing-lg);
        }
        
        header { 
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--card-bg-light) 100%);
            padding: var(--spacing-sm) 0; /* Reduced from var(--spacing-lg) */
            box-shadow: 0 2px 8px rgba(0,0,0,0.6);
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--medium-gray);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        header .header-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 var(--spacing-md); /* Reduced from var(--spacing-lg) */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header .header-left {
            text-align: left;
        }
        
        h1 { 
            color:var(--primary-blue); 
            font-size:1.75rem; /* Reduced from 2.75rem */
            margin-bottom:0.25rem; /* Reduced from var(--spacing-xs) */
            font-weight:700;
            letter-spacing:-0.025em;
        }
        
        .subtitle { 
            color:var(--dark-gray); 
            font-size:0.875rem; /* Reduced from 1.125rem */
            font-weight:400;
        }

        .nav-tabs { 
            display:flex; 
            gap:var(--spacing-sm); 
            align-items: center;
        }
        
        .nav-tab { 
            padding:var(--spacing-sm) var(--spacing-md); 
            background:var(--light-gray); 
            border:none; 
            border-radius:var(--radius-md); 
            cursor:pointer; 
            font-size:1rem; 
            font-weight:600; 
            color:var(--text-dark); 
            transition:all .25s ease;
            border: 2px solid transparent;
        }
        
        .nav-tab:hover { 
            background:var(--light-blue); 
            transform:translateY(-1px);
            border-color: var(--accent-blue);
        }
        
        .nav-tab.active { 
            background:var(--primary-blue); 
            color:var(--white); 
            box-shadow:var(--shadow-sm);
            border-color: var(--dark-blue);
        }

        .content-section { 
            display:none; 
            background:var(--card-bg); 
            padding:var(--spacing-xl); 
            border-radius:var(--radius-lg); 
            box-shadow:var(--shadow-md);
            border: 1px solid var(--medium-gray);
        }
        
        .content-section.active { display:block; }

        .btn { 
            padding:var(--spacing-sm) var(--spacing-md); 
            border:none; 
            border-radius:var(--radius-md); 
            cursor:pointer; 
            font-size:1rem; 
            font-weight:600; 
            transition:all .25s ease;
            box-shadow:var(--shadow-xs);
        }
        
        .btn:hover { 
            transform:translateY(-2px); 
            box-shadow:var(--shadow-md);
        }
        
        .btn:active {
            transform:translateY(0);
        }
        
        .btn-primary { 
            background:var(--primary-blue); 
            color:var(--white);
        }
        
        .btn-primary:hover { 
            background:var(--dark-blue);
        }
        
        .btn-success { 
            background:var(--success); 
            color:var(--white);
        }
        
        .btn-success:hover {
            background:#059669;
        }
        
        .btn-danger { 
            background:var(--danger); 
            color:var(--white);
        }
        
        .btn-danger:hover {
            background:#DC2626;
        }
        
        .btn-secondary { 
            background:var(--medium-gray); 
            color:var(--text-dark);
        }
        
        .btn-secondary:hover {
            background:var(--dark-gray);
            color:var(--white);
        }
        
        .btn-sm { 
            padding:.5rem .875rem; 
            font-size:.875rem;
        }

        /* Summary Cards */
        .summary-row {
            display:grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        /* Net Worth Row */
        .networth-row {
            display:grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .summary-card {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            color: var(--white);
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform .25s ease, box-shadow .25s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .summary-card.networth-card {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }
        
        .summary-card h3 { 
            font-size:.95rem; 
            font-weight:600; 
            opacity:.95; 
            margin-bottom:var(--spacing-xs);
            text-transform:uppercase;
            letter-spacing:0.05em;
            color: var(--white);
        }
        
        .summary-card .value { 
            font-size:1.875rem; 
            font-weight:700;
            margin-bottom:var(--spacing-xs);
        }

        /* Wide Cards */
        .wide-row { 
            display:block; 
            margin-bottom: var(--spacing-lg);
        }
        
        .wide-card {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: var(--white);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .balances-grid { 
            display:flex; 
            gap:var(--spacing-md); 
            flex-wrap:wrap; 
            margin-top:var(--spacing-md);
        }
        
        .balance-item { 
            background: rgba(255,255,255,0.12); 
            padding:var(--spacing-md); 
            border-radius:var(--radius-md); 
            min-width:180px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all .25s ease;
        }
        
        .balance-item:hover {
            background: rgba(255,255,255,0.18);
            transform: translateY(-2px);
        }

        /* Owed Card */
        .owed-card { 
            background:var(--white); 
            padding:var(--spacing-lg); 
            border-radius:var(--radius-lg); 
            box-shadow:var(--shadow-md); 
            margin-top:var(--spacing-lg);
            border: 1px solid var(--medium-gray);
        }
        
        .owed-card-header { 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            margin-bottom:var(--spacing-md);
            padding-bottom:var(--spacing-md);
            border-bottom: 2px solid var(--medium-gray);
        }
        
        .owed-list { 
            max-height:320px; 
            overflow:auto;
        }
        
        .owed-row { 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            padding:var(--spacing-md); 
            border-bottom:1px solid var(--medium-gray); 
            gap:var(--spacing-sm);
            transition: background .2s ease;
            border-radius: var(--radius-sm);
        }
        
        .owed-row:hover {
            background: var(--light-gray);
        }
        
        .owed-row .name { 
            font-weight:700;
            color: var(--primary-blue);
        }
        
        .owed-actions { 
            display:flex; 
            gap:.5rem;
        }

        /* Filter & Table */
        .filter-row { 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            gap: var(--spacing-sm); 
            margin-top:var(--spacing-lg); 
            margin-bottom:var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--light-gray);
            border-radius: var(--radius-md);
        }
        
        .filter-row .left { 
            display:flex; 
            gap:var(--spacing-sm); 
            align-items:center;
        }
        
        .table-container { 
            overflow-x:auto;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--medium-gray);
        }
        
        table { 
            width:100%; 
            border-collapse:collapse; 
            background:var(--white);
        }
        
        thead { 
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
            color:var(--white);
        }
        
        th { 
            padding:var(--spacing-md); 
            text-align:left;
            font-weight:700;
            text-transform:uppercase;
            font-size:0.875rem;
            letter-spacing:0.05em;
        }
        
        td { 
            padding:var(--spacing-md); 
            border-bottom:1px solid var(--medium-gray);
        }
        
        tbody tr {
            transition: background .2s ease;
        }
        
        tbody tr:hover { 
            background:var(--light-blue);
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }

        /* Shared Table */
        .shared-table { 
            width:100%; 
            border-collapse:collapse; 
            margin-top:var(--spacing-sm);
            border: 1px solid var(--medium-gray);
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .shared-table th { 
            padding:var(--spacing-sm); 
            border-bottom:2px solid var(--medium-gray); 
            text-align:left;
            background: var(--light-gray);
            font-weight:600;
            color: var(--text-dark);
        }
        
        .shared-table td { 
            padding:var(--spacing-sm); 
            border-bottom:1px solid var(--medium-gray);
        }
        
        .shared-table input[type="number"] { 
            width:110px; 
            padding:0.5rem; 
            border:2px solid var(--medium-gray); 
            border-radius:var(--radius-sm);
            transition: border-color .2s ease;
            color: var(--text-dark);  /* Add this line */
            background: var(--card-bg);  /* Also add background for consistency */
        }
        
        .shared-table input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        /* Forms */
        .form-group { 
            margin-bottom:var(--spacing-md);
        }
        
        .form-group label { 
            display:block; 
            margin-bottom:var(--spacing-xs); 
            font-weight:600; 
            color:var(--dark-blue);
            font-size: 0.95rem;
        }
        
        .form-group input, .form-group select, .form-group textarea { 
            width:100%; 
            padding:var(--spacing-sm); 
            border:2px solid var(--medium-gray); 
            border-radius:var(--radius-md); 
            font-size:1rem; 
            transition:border-color .2s ease, box-shadow .2s ease;
            background: var(--white);
            color: var(--text-dark);  /* Add this line */
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-row { 
            display:grid; 
            grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); 
            gap:var(--spacing-md);
        }
        
        /* Modal */
        .modal { 
            display:none; 
            position:fixed; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%; 
            background:rgba(0,0,0,0.6); 
            z-index:1000; 
            align-items:center; 
            justify-content:center;
            backdrop-filter: blur(4px);
        }
        
        .modal.active { 
            display:flex;
        }
        
        .modal-content { 
            background:var(--white); 
            padding:var(--spacing-xl); 
            border-radius:var(--radius-lg); 
            box-shadow:var(--shadow-xl); 
            max-width:900px; 
            width:94%; 
            max-height:90vh; 
            overflow-y:auto;
            border: 1px solid var(--medium-gray);
        }
        
        .modal-header { 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            margin-bottom:var(--spacing-md); 
            padding-bottom:var(--spacing-md); 
            border-bottom:2px solid var(--medium-gray);
        }
        
        .modal-header h2 {
            color: var(--primary-blue);
            font-weight: 700;
        }
        
        .close-modal { 
            background:none; 
            border:none; 
            font-size:2rem; 
            cursor:pointer; 
            color:var(--dark-gray); 
            line-height:1;
            transition: color .2s ease, transform .2s ease;
            padding: 0.25rem;
            border-radius: var(--radius-sm);
        }
        
        .close-modal:hover { 
            color:var(--danger);
            transform: rotate(90deg);
        }

        #subcategory-modal .modal-content {
            max-width: 1000px;
        }

        .small-muted { 
            font-size:.9rem; 
            color: rgba(255,255,255,0.9);
        }
        
        .small-muted-dark {
            font-size:.9rem;
            color: var(--dark-gray);
        }

        /* Multi-select dropdown styles */
        .period-checkbox-label:hover {
            background: var(--light-gray);
        }

        .inline-input { 
            display:flex; 
            gap:.5rem; 
            align-items:center;
        }
        
        .hidden { 
            display:none;
        }
        
        .collapsible-toggle { 
            cursor:pointer; 
            background:none; 
            border:none; 
            font-weight:700; 
            color:var(--dark-blue);
        }

        /* Period Cards */
        .periods-grid {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }
        
        .period-card.current-period {
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.95) 0%, rgba(55, 65, 81, 0.95) 100%); /* Much darker, matching theme */
            border: 3px solid var(--primary-blue);
            padding: var(--spacing-xl);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
        }
        
        .period-card.current-period h3 {
            font-size: 1.5rem;
        }
        
        .past-periods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }
        
        .period-card.past-period {
            padding: var(--spacing-md);
        }
        
        .period-card.past-period h3 {
            font-size: 1.1rem;
        }
        
        .period-card.past-period .period-summary-top {
            grid-template-columns: 1fr;
            gap: var(--spacing-sm);
        }
        
        .period-card.past-period .period-stat-box {
            padding: var(--spacing-sm);
        }
        
        .period-card.past-period .period-stat-value {
            font-size: 1.2rem;
        }

        .period-card {
            background:var(--white); 
            padding:var(--spacing-lg); 
            border-radius:var(--radius-lg); 
            box-shadow:var(--shadow-md); 
            cursor:pointer;
            transition: all .3s ease;
            border: 2px solid var(--medium-gray);
            position: relative;
        }
        
        .period-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-blue);
        }
        
        .period-card h3 {
            color: var(--dark-blue);
            font-size: 1.25rem;
            margin-bottom: var(--spacing-md);
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .period-card small {
            color: var(--dark-gray);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .period-days-badge {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .period-days-badge.active {
            background: linear-gradient(135deg, var(--warning) 0%, #F97316 100%);
            color: var(--white);
        }

        .period-days-badge.complete {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: var(--white);
        }

        .period-summary-top {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .period-stat-box {
            background: linear-gradient(135deg, var(--light-gray) 0%, var(--white) 100%);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--medium-gray);
        }

        .period-stat-label {
            font-size: 0.85rem;
            color: var(--dark-gray);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .period-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .period-stat-subtext {
            font-size: 0.8rem;
            color: var(--dark-gray);
            margin-top: 0.25rem;
        }

        /* Progress Bars in Period Cards */
        .period-progress-section {
            margin-bottom: var(--spacing-md);
        }

        .period-progress-item {
            margin-bottom: var(--spacing-sm);
        }

        .period-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.375rem;
        }

        .period-progress-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .period-progress-amount {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--dark-gray);
        }

        .period-progress-bar-container {
            width: 100%;
            height: 10px;
            background: var(--light-gray);
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .period-progress-bar {
            height: 100%;
            border-radius: 5px;
            transition: width 0.4s ease;
            position: relative;
        }

        .period-progress-bar.bills {
            background: linear-gradient(90deg, #3B82F6 0%, #60A5FA 100%);
        }

        .period-progress-bar.food {
            background: linear-gradient(90deg, #10B981 0%, #34D399 100%);
        }

        .period-progress-bar.wants {
            background: linear-gradient(90deg, #8B5CF6 0%, #A78BFA 100%);
        }

        .period-progress-bar.over {
            background: linear-gradient(90deg, #EF4444 0%, #F87171 100%);
        }

        /* Savings Indicator */
        .period-savings-indicator {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            color: var(--white);
            text-align: center;
        }

        .period-savings-label {
            font-size: 0.85rem;
            font-weight: 600;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .period-savings-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }

        .period-savings-subtext {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        h2 {
            color: var(--primary-blue);
            font-weight: 700;
            margin-bottom: var(--spacing-md);
        }

        h3 {
            color: var(--primary-blue);
            font-weight: 700;
        }

        /* Settings page styling */
        .settings-card {
            background:var(--light-gray); 
            padding:var(--spacing-lg); 
            border-radius:var(--radius-lg);
            border: 1px solid var(--medium-gray);
            box-shadow: var(--shadow-sm);
        }

        /* Budget Progress Bars */
        .progress-item {
            margin-bottom: var(--spacing-md);
        }
        
        .progress-item:last-child {
            margin-bottom: 0;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xs);
        }
        
        .progress-label {
            font-weight: 700;
            color: var(--text-dark);
            font-size: 1rem;
        }
        
        .progress-values {
            font-size: 0.9rem;
            color: var(--dark-gray);
            font-weight: 600;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 28px;
            background: var(--light-gray);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-bar-fill {
            height: 100%;
            transition: width 0.5s ease, background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 0.85rem;
        }
        
        .progress-bar-fill.under-50 {
            background: linear-gradient(90deg, var(--success) 0%, #34D399 100%);
        }
        
        .progress-bar-fill.under-80 {
            background: linear-gradient(90deg, #34D399 0%, var(--warning) 100%);
        }
        
        .progress-bar-fill.under-100 {
            background: linear-gradient(90deg, var(--warning) 0%, #FB923C 100%);
        }
        
        .progress-bar-fill.over-100 {
            background: linear-gradient(90deg, var(--danger) 0%, #DC2626 100%);
        }

        /* Text colors */
        .text-success {
            color: var(--success);
        }
        
        .text-danger {
            color: var(--danger);
        }

        /* Subcategory Management */
        .subcategory-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .subcategory-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            background: var(--light-blue);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-blue);
        }
        
        .subcategory-chip button {
            margin-left: 0.5rem;
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-weight: bold;
            padding: 0 0.25rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .networth-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 900px) {
            .summary-row { 
                grid-template-columns: repeat(2,1fr);
            }
            
            .networth-row {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 600px) {
            .summary-row { 
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: var(--spacing-sm);
            }
            
            .content-section {
                padding: var(--spacing-md);
            }
            
            h1 {
                font-size: 1.75rem;
            }
        }

        /* Smooth scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--medium-gray);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark-gray);
        }
    </style>
</head>
<body>
    <div class="container">
            <header>
                <div class="header-content">
                    <div class="header-left">
                        <h1>üí∞ Budget Tracker</h1>
                        <p class="subtitle">Manage your finances with ease</p>
                    </div>
                    <div class="header-right">
                        <nav class="nav-tabs">
                            <button class="nav-tab active" id="tab-home">üè† Home</button>
                            <button class="nav-tab" id="tab-summary">üìä Full Summary</button>
                            <button class="btn btn-success" id="btn-save-cloud" style="font-weight:700;">
                                üíæ Save to Cloud
                            </button>
                            <button class="nav-tab" id="tab-settings" style="font-size:1.5rem; padding:var(--spacing-sm);">
                                ‚öôÔ∏è
                            </button>
                        </nav>
                    </div>
                </div>
            </header>

        <section id="home" class="content-section active">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--spacing-lg);">
                <h2>Budget Periods</h2>
                <div style="display:flex; gap:var(--spacing-sm);">
                    <button class="btn btn-primary" id="btn-home-add-expense">‚ûï Add Expense</button>
                    <button class="btn btn-primary" id="btn-new-period">‚ûï New Period</button>
                </div>
            </div>

            <!-- Current Balances & Debts -->
            <div id="home-balances-card" style="background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));padding:var(--spacing-lg);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);margin-bottom:var(--spacing-lg);border:2px solid var(--gold);">
                <!-- Populated by JavaScript -->
            </div>

            <div id="periods-container" class="periods-grid"></div>
        </section>

        <section id="period-detail" class="content-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--spacing-lg); flex-wrap:wrap; gap:var(--spacing-sm);">
                <div style="display:flex; align-items:center; gap:var(--spacing-sm);">
                    <button class="btn btn-secondary" id="btn-back-home">‚Üê Back</button>
                    <h2 style="margin:0;" id="period-title"></h2>
                </div>
                <div style="display:flex; gap:var(--spacing-sm); flex-wrap:wrap;">
                    <button class="btn btn-primary" id="btn-add-expense">‚ûï Add Expense</button>
                    <button class="btn btn-secondary" id="btn-edit-balances">üí≥ Edit Balances</button>
                    <button class="btn btn-success" id="btn-export-csv">üì• Export CSV</button>
                </div>
            </div>

            <!-- NET WORTH ROW -->
            <div class="networth-row" id="networth-cards">
                <!-- filled dynamically -->
            </div>

            <!-- TOP ROW: 5 summary cards -->
            <div class="summary-row" id="period-summary-cards">
                <!-- filled dynamically -->
            </div>

            <!-- BUDGET PROGRESS & PIE CHART ROW -->
            <div style="display:grid; grid-template-columns:2fr 1fr; gap:var(--spacing-lg); margin-bottom:var(--spacing-lg);">
                <!-- BUDGET PROGRESS BARS -->
                <div style="background:var(--white); padding:var(--spacing-lg); border-radius:var(--radius-lg); box-shadow:var(--shadow-md); border: 1px solid var(--medium-gray);">
                    <h3 style="color:var(--dark-blue); margin-bottom:var(--spacing-md);">üìä Budget Progress</h3>
                    <div id="budget-progress-bars">
                        <!-- filled dynamically -->
                    </div>
                </div>

                <!-- CATEGORY BREAKDOWN PIE CHART -->
                <div style="background:var(--white); padding:var(--spacing-lg); border-radius:var(--radius-lg); box-shadow:var(--shadow-md); border: 1px solid var(--medium-gray);">
                    <h3 style="color:var(--dark-blue); margin-bottom:var(--spacing-md);">ü•ß Spending Breakdown</h3>
                    <div style="height:300px; position:relative;">
                        <canvas id="period-detail-pie-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SECOND ROW: balances & debts wide card -->
            <div class="wide-row">
                <div class="wide-card" id="balances-card">
                    <!-- filled dynamically -->
                </div>
            </div>

            <!-- THIRD ROW: Money Owed to Me -->
            <div id="owed-wrapper">
                <div class="owed-card" id="owed-card">
                    <div class="owed-card-header">
                        <div>
                            <h3 style="margin:0; color:var(--dark-blue);">üíµ Money Owed to Me</h3>
                            <div class="small-muted-dark" id="owed-subtext">Manage who owes you ‚Äî add, edit or remove directly.</div>
                            <div style="font-weight:700; font-size:1.1rem; color:var(--primary-blue); margin-top:0.25rem;" id="owed-total">Total: ¬£0.00</div>
                        </div>
                        <div style="display:flex; gap:.5rem; align-items:center;">
                            <button class="btn btn-sm btn-secondary" id="toggle-owed">‚ñ≤ Hide</button>
                            <button class="btn btn-sm btn-primary" id="btn-add-owed-inline">‚ûï Add New</button>
                        </div>
                    </div>

                    <div id="owed-add-area" class="hidden" style="margin-bottom:var(--spacing-md);">
                        <div style="display:flex; gap:var(--spacing-sm);">
                            <input type="text" id="new-owed-name" placeholder="Person's name" />
                            <input type="number" id="new-owed-amount" placeholder="Amount" step="0.01" />
                            <button class="btn btn-primary" id="save-owed-new">Save</button>
                            <button class="btn btn-secondary" id="cancel-owed-new">Cancel</button>
                        </div>
                    </div>

                    <div id="owed-list" class="owed-list">
                        <!-- rows dynamically -->
                    </div>
                </div>
            </div>

            <!-- TRANSACTIONS FILTER + TABLE -->
            <div class="filter-row">
                <div class="left">
                    <label for="filter-category" style="font-weight:600;color:var(--dark-blue);">üîç Filter:</label>
                    <select id="filter-category">
                        <option value="All">All</option>
                        <option value="Bills/Subscriptions">Bills/Subscriptions</option>
                        <option value="One-off Needs">One-off Needs</option>
                        <option value="Wants">Wants</option>
                        <option value="Food">Food</option>
                        <option value="Unexpected">Unexpected</option>
                        <option value="Income">Income</option>
                    </select>
                </div>
                <div>
                    <input type="text" id="filter-text" placeholder="üîé Search description..." />
                </div>
            </div>

            <div style="margin-top:var(--spacing-lg);">
                <h3 style="color:var(--dark-blue); margin-bottom:var(--spacing-md);">üìã Transactions</h3>
                <div class="table-container">
                    <table id="transactions-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Payment Method</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-tbody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Subcategory Transactions Modal (moved outside period-detail) -->
    <div id="subcategory-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="subcategory-modal-title">Transactions</h2>
                <button class="close-modal" id="close-subcategory-modal">&times;</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Subcategory</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="subcategory-transactions-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

        <section id="summary" class="content-section">
            <h2 style="margin-bottom:var(--spacing-lg);">üìä Full Summary - All Periods</h2>
            <div id="full-summary-content"></div>
        </section>

        <section id="settings" class="content-section">
            <h2 style="margin-bottom:var(--spacing-lg);">‚öôÔ∏è Settings</h2>
            <div style="display:grid; gap:var(--spacing-lg);">
                <div class="settings-card">
                    <h3 style="color:var(--dark-blue); margin-bottom:var(--spacing-md);">üíæ Data Management</h3>
                    <div style="display:flex; gap:var(--spacing-sm); flex-wrap:wrap;">
                        <button class="btn btn-success" id="btn-export-all">üì§ Export All Data</button>
                        <button class="btn btn-primary" id="btn-import-trigger">üì• Import Data</button>
                        <input type="file" id="import-file" accept=".json" style="display:none;">
                        <button class="btn btn-danger" id="btn-clear-all">üóëÔ∏è Clear All Data</button>
                    </div>
                    <p style="margin-top:var(--spacing-md); color:var(--dark-gray); font-size:0.95rem;">
                        üí° <strong>Tip:</strong> Export your data regularly as a backup!
                    </p>
                </div>

                <div class="settings-card">
                    <h3 style="color:var(--dark-blue); margin-bottom:var(--spacing-md);">üè∑Ô∏è Subcategory Management</h3>
                    <p style="color:var(--dark-gray); margin-bottom:var(--spacing-md);">
                        Customize subcategories for each category. These will appear in the dropdown when adding expenses.
                    </p>
                    <div id="subcategory-management">
                        <!-- filled dynamically -->
                    </div>
                </div>

                <div class="settings-card">
                    <h3 style="color:var(--dark-blue); margin-bottom:var(--spacing-md);">üè¶ Bank Account Management</h3>
                    <p style="color:var(--dark-gray); margin-bottom:var(--spacing-md);">
                        Add or remove bank accounts. Credit cards and loans will be treated as negative values in net worth calculations.
                    </p>
                    <div id="bank-account-management">
                        <!-- filled dynamically -->
                    </div>
                    <div class="inline-input" style="margin-top:var(--spacing-md);">
                        <input type="text" id="new-account-name" placeholder="Account name (e.g., Starling Current)">
                        <select id="new-account-type" style="padding:0.5rem; border:2px solid var(--medium-gray); border-radius:var(--radius-md); background:var(--white); color:var(--text-dark);">
                            <option value="debit">Bank Account (Debit)</option>
                            <option value="credit">Credit Card</option>
                            <option value="loan">Loan</option>
                        </select>
                        <button class="btn btn-sm btn-primary" onclick="addBankAccount()">Add Account</button>
                    </div>
                </div>

                <div class="settings-card" style="background:var(--light-blue);">
                    <h3 style="color:var(--dark-blue); margin-bottom:var(--spacing-md);">‚ÑπÔ∏è About</h3>
                    <p style="color:var(--text-dark); line-height:1.8;">
                        This budget tracker stores all data in your browser's LocalStorage.
                        Your data is private and never leaves your device. üîí
                    </p>
                </div>
            </div>
        </section>
    </div>

    <!-- New Period Modal -->
    <div id="new-period-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Period</h2>
                <button class="close-modal" id="close-new-period">&times;</button>
            </div>
            <form id="new-period-form">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="period-start-date" required readonly>
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="period-end-date" required>
                </div>
                <div class="form-group">
                    <label>Monthly Salary</label>
                    <input type="number" id="period-salary" step="0.01" required>
                </div>

                <h3 style="color:var(--dark-blue); margin:var(--spacing-md) 0;">Starting Balances</h3>
                <div id="starting-balances-fields">
                    <!-- Dynamically generated based on bankAccounts -->
                </div>

                <h3 style="color:var(--dark-blue); margin:var(--spacing-md) 0;">Budget Targets</h3>
                <p style="color:var(--dark-gray); margin-bottom:var(--spacing-sm);">
                    Set budgets as amounts or percentage of salary
                </p>
                <div class="form-row">
                    <div class="form-group">
                        <label>Bills Budget</label>
                        <div style="display:flex; gap:var(--spacing-xs);">
                            <input type="number" id="budget-bills-amount" step="0.01" placeholder="Amount">
                            <input type="number" id="budget-bills-percent" step="0.1" placeholder="Percent">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Food Budget</label>
                        <div style="display:flex; gap:var(--spacing-xs);">
                            <input type="number" id="budget-food-amount" step="0.01" placeholder="Amount">
                            <input type="number" id="budget-food-percent" step="0.1" placeholder="Percent">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Wants Budget</label>
                        <div style="display:flex; gap:var(--spacing-xs);">
                            <input type="number" id="budget-wants-amount" step="0.01" placeholder="Amount">
                            <input type="number" id="budget-wants-percent" step="0.1" placeholder="Percent">
                        </div>
                    </div>
                </div>

                <div style="display:flex; gap:var(--spacing-sm); margin-top:var(--spacing-md);">
                    <button type="submit" class="btn btn-primary">Create Period</button>
                    <button type="button" class="btn btn-secondary" id="cancel-new-period">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expense-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="expense-modal-title">Add Expense</h2>
                <button class="close-modal" id="close-expense">&times;</button>
            </div>
            <form id="expense-form">
                <input type="hidden" id="expense-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="expense-date" required>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="expense-amount" step="0.01" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="expense-description" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="expense-category" required>
                            <option value="">Select Category</option>
                            <option value="Bills/Subscriptions">Bills/Subscriptions</option>
                            <option value="One-off Needs">One-off Needs</option>
                            <option value="Wants">Wants (Treats)</option>
                            <option value="Food">Food</option>
                            <option value="Unexpected">Unexpected</option>
                            <option value="Income">Income</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Subcategory</label>
                        <select id="expense-subcategory" required>
                            <option value="">Select Subcategory</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Payment Method</label>
                        <select id="expense-payment" required>
                            <option value="">Select Payment Method</option>
                            <!-- Dynamically populated from bankAccounts -->
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                    <div class="form-group" style="visibility:hidden;">
                        <label style="opacity:0;">placeholder</label>
                        <input style="opacity:0; height:1px;">
                    </div>
                </div>

                <!-- SHARED CONTROLS -->
                <div class="form-group" id="shared-controls">
                    <label>Shared With (who owes the rest)</label>
                    <table class="shared-table" id="expense-shared-table">
                        <thead>
                            <tr>
                                <th style="width:40%;">Name</th>
                                <th style="width:25%;">Currently Owes</th>
                                <th style="width:35%;">Owes From This Expense</th>
                            </tr>
                        </thead>
                        <tbody id="expense-shared-body">
                            <!-- populated dynamically -->
                        </tbody>
                    </table>

                    <div class="inline-input" style="margin-top:var(--spacing-sm);">
                        <input type="text" id="expense-add-person" placeholder="Add new person (name)">
                        <button type="button" class="btn btn-sm btn-primary" id="btn-add-person">Add</button>
                    </div>
                </div>

                <div class="form-row" id="income-controls" style="display:none;">
                    <div class="form-group">
                        <label>Received From (if income & reduces someone's debt)</label>
                        <select id="expense-received-from">
                            <option value="">Select person</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Apply Amount To Debt (optional)</label>
                        <input type="number" id="expense-apply-debt" step="0.01" placeholder="Leave blank to treat as general income">
                    </div>
                </div>

                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="expense-notes" rows="3"></textarea>
                </div>

                <div style="display:flex; gap:var(--spacing-sm); margin-top:var(--spacing-md);">
                    <button type="submit" class="btn btn-primary">Save Expense</button>
                    <button type="button" class="btn btn-secondary" id="cancel-expense">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Balances Modal -->
    <div id="edit-balances-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Account Balances</h2>
                <button class="close-modal" id="close-edit-balances">&times;</button>
            </div>
            <form id="edit-balances-form">
                <p style="color:var(--dark-gray); margin-bottom:var(--spacing-md);">
                    üí° Use this to transfer money between accounts or correct balances
                </p>
                <div id="edit-balances-fields">
                    <!-- Dynamically generated based on bankAccounts -->
                </div>

                <div style="display:flex; gap:var(--spacing-sm); margin-top:var(--spacing-md);">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" id="cancel-edit-balances">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL STATE
        // ============================================
        let currentPeriodId = null;
        let editingExpenseId = null;
        Chart.defaults.color = '#F9FAFB'; // Light text color for all charts
        Chart.defaults.borderColor = '#4B5563'; // Grid line color
                // Global in-memory storage for the periods data
        let periods = []; 
        
        // API Endpoints for the Netlify Functions
        // üö® IMPORTANT: Replace YOUR_SITE_URL with your actual Netlify domain!
        const API_GET_URL = "https://declanfinanceapp.netlify.app/.netlify/functions/get-data";
        const API_SAVE_URL = "https://declanfinanceapp.netlify.app/.netlify/functions/save-data";
        const ACCESS_PASSWORD = '972912';
        // ============================================
        // SUBCATEGORIES MAPPING (now stored/loaded from localStorage)
        // ============================================
        let subcategories = {
            'Bills/Subscriptions': ['Utilities', 'Software', 'Entertainment', 'Transport', 'Communication', 'Health', 'Debt Payment', 'Rent'],
            'One-off Needs': ['Transport', 'Household', 'Health', 'Clothing'],
            'Wants': ['Entertainment', 'Shopping', 'Gifts', 'Gaming', 'Clothing', 'Charity', 'Gambling', 'Collectibles', 'Drinks', 'App', 'Loan'],
            'Food': ['Groceries', 'Takeaway', 'Restaurant', 'Fast Food', 'Treats', 'Snacks', 'Drinks'],
            'Unexpected': ['Transport', 'Medical', 'Repairs', 'Fines', 'Gifts/Annual', 'Insurance'],
            'Income': ['Salary', 'Freelance', 'Gifts', 'Refund', 'Interest', 'Other']
        };

        // ============================================
        // BANK ACCOUNTS MAPPING (stored/loaded from database)
        // ============================================
        let bankAccounts = [
            { name: 'Starling Current', type: 'debit', key: 'starlingCurrent' },
            { name: 'Starling Saver', type: 'debit', key: 'starlingSaver' },
            { name: 'Lloyds Credit', type: 'credit', key: 'lloydsCredit' },
            { name: 'Natwest Credit', type: 'credit', key: 'natwestCredit' },
            { name: 'Virgin Credit', type: 'credit', key: 'virginCredit' }
        ];

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // This is the core fix: making the modal visible
                modal.classList.add('active'); 
                // Or if you prefer inline style: modal.style.display = 'block';
                console.log(`Modal ${modalId} opened.`);
            } else {
                console.error(`Error: Modal element not found with ID: ${modalId}`);
            }
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // This hides the modal
                modal.classList.remove('active');
                // Or if you prefer inline style: modal.style.display = 'none';
                console.log(`Modal ${modalId} closed.`);
            }
        }

        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            
            // Fallback to console if the UI element is missing
            if (!container) {
                if (type === 'error') {
                    console.error(`[Message: ${type.toUpperCase()}] ${message}`);
                } else {
                    console.log(`[Message: ${type.toUpperCase()}] ${message}`);
                }
                return;
            }
        
            // Standard UI implementation (using a timeout for display)
            container.textContent = message;
            container.className = `p-2 my-2 text-sm rounded-lg text-center bg-${type}-100 text-${type}-700`;
            container.style.display = 'block';
        
            setTimeout(() => {
                container.style.display = 'none';
                container.textContent = '';
            }, 5000);
        }

        
        // DELETE the old loadSubcategories() and replace it with this:
        function loadSubcategories() {
            // This function is now mainly used to ensure the subcategories are available
            // in memory, which they will be after the database fetch.
            // If your app has specific UI refresh logic tied to this, it stays here.
            // For now, it simply ensures the global variable is ready.
            if (typeof subcategories === 'undefined') {
                console.warn("Subcategories global variable is missing.");
            }
        }

        // DELETE the old saveSubcategories() and replace it with this:
        async function saveSubcategories() {
            // Since subcategories are part of the full application state, 
            // saving them triggers a full save to the database.
            await saveAllDataToDatabase(); 
        }

        // ============================================
        // LOCALSTORAGE HELPERS (periods)
        // ============================================
        function getPeriods() {
            return periods; // Returns the global in-memory array
        }
        async function savePeriods(newPeriods) {
            // 1. Update the global in-memory array
            periods = newPeriods; 
            
            // 2. Refresh the UI immediately
            loadPeriods(); 
            
            // 3. DO NOT trigger database save here. Save is now tied to the Export button.
        }

        function getPeriod(periodId) {
            const periods = getPeriods();
            return periods.find(p => p.id === periodId) || null;
        }
        function updatePeriod(periodId, updatedPeriod) {
            const periods = getPeriods();
            const i = periods.findIndex(p => p.id === periodId);
            if (i !== -1) { 
                periods[i] = updatedPeriod; 
                savePeriods(periods); // This calls the non-saving version of savePeriods
            }
        }

        async function initializeDataFromDatabase() {
    // ----------------------------------------------------
    // 1. PASSWORD CHECK (NEW)
    // ----------------------------------------------------
    const enteredPassword = prompt("Enter the access password to load data:");
    
    if (enteredPassword !== ACCESS_PASSWORD) {
        showMessage('Access denied. Incorrect password.', 'error');
        console.error("Access attempt failed.");
        document.getElementById('periods-container').innerHTML = '<p style="text-align:center;color:var(--danger);padding:var(--spacing-xl);">üö´ Access Denied. Please refresh and enter the correct password.</p>';
        // Exit function early if password is wrong
        return; 
    }
    showMessage('Access granted. Loading data...', 'info');

    // ----------------------------------------------------
    // 2. DATA LOAD (ORIGINAL LOGIC)
    // ----------------------------------------------------
    console.log("Attempting to load data from Netlify API...");
    try {
        const response = await fetch(API_GET_URL);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        // Expecting the combined object: { periods: [...], subcategories: {...}, bankAccounts: [...] }
        const fullDataObject = await response.json();

        // 1. SET the global 'periods' array
        periods = fullDataObject.periods || [];

        // 2. SET the global 'subcategories' object
        // Use loaded data if available, otherwise keep the default defined in the HTML
        if (fullDataObject.subcategories && Object.keys(fullDataObject.subcategories).length > 0) {
            subcategories = fullDataObject.subcategories;
        }

        // 3. SET the global 'bankAccounts' array
        // Use loaded data if available, otherwise keep the default defined in the HTML
        if (fullDataObject.bankAccounts && fullDataObject.bankAccounts.length > 0) {
            bankAccounts = fullDataObject.bankAccounts;
        }

        // 4. Refresh the UI using the now populated global data
        loadPeriods(); 
        
        showMessage('Data successfully loaded from database. ‚úÖ', 'success');
        console.log('Data successfully loaded from Neon DB via Netlify API. ‚úÖ');

    } catch (error) {
        console.error("Error loading initial finance data from API:", error);
        // Display an alert and a UI error message
        showMessage('Failed to load data from database. Check console for details.', 'error');
        document.getElementById('periods-container').innerHTML = '<p style="text-align:center;color:var(--danger);padding:var(--spacing-xl);">‚ö†Ô∏è Failed to load data from database. See console for details.</p>';
    }
}
        
        
        // ============================================
        // APP STARTUP (STEP 44)
        // ============================================
        
        // Replace the old loadPeriods() call with the new database initializer
        initializeDataFromDatabase();


        
        // ============================================
        // NAV & MODALS
        // ============================================
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (sectionId === 'home') document.getElementById('tab-home').classList.add('active');
            if (sectionId === 'summary') { document.getElementById('tab-summary').classList.add('active'); loadFullSummary(); }
            if (sectionId === 'settings') {
                document.getElementById('tab-settings').classList.add('active');
                renderSubcategoryManagement();
                renderBankAccountManagement();
            }
        }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // ============================================
        // PERIOD UI & MANAGEMENT
        // ============================================
       function loadPeriods() {
    const periods = getPeriods();
    const container = document.getElementById('periods-container');
    if (periods.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--dark-gray);padding:var(--spacing-xl);">No periods yet. Create your first one! üöÄ</p>';
        document.getElementById('home-balances-card').innerHTML = '<p style="text-align:center;color:rgba(255,255,255,0.9);padding:var(--spacing-md);">No balances to display yet. üí∞</p>';
        return;
    }
    periods.sort((a,b) => new Date(b.startDate) - new Date(a.startDate));

    // Display current balances from the most recent period
    const latestPeriod = periods[0];
    const sb = latestPeriod.startingBalances || {};
    const totalSavings = calculateTotalDebit(sb);
    const totalDebt = calculateTotalCredit(sb);

    const accountsHtml = bankAccounts.map(account => {
        const typeIcon = account.type === 'debit' ? 'üí≥' : account.type === 'credit' ? 'üî¥' : 'üí∞';
        return `<div class="balance-item"><strong>${typeIcon} ${escapeHtml(account.name)}</strong><div style="font-size:1.25rem;margin-top:0.25rem;">¬£${formatCurrency(sb[account.key]||0)}</div></div>`;
    }).join('');

    document.getElementById('home-balances-card').innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:var(--spacing-md);">
            <div>
                <h3 style="margin:0;color:#3B82F6;font-size:1.5rem;">üí≥ Current Balances & Debts</h3>
                <div class="small-muted" style="color:rgba(255,255,255,0.9)">All accounts shown (positive = balance, credit card = owed)</div>
            </div>
            <div style="text-align:right;">
                <div style="font-weight:700;font-size:1.3rem">üí∞ Savings: ¬£${formatCurrency(totalSavings)}</div>
                <div style="font-weight:700;font-size:1.3rem">üí≥ Debt: ¬£${formatCurrency(totalDebt)}</div>
            </div>
        </div>
        <div class="balances-grid">
            ${accountsHtml}
        </div>
    `;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Separate current and past periods
    const currentPeriods = [];
    const pastPeriods = [];
    
    periods.forEach(period => {
        const endDate = new Date(period.endDate);
        endDate.setHours(0, 0, 0, 0);
        const daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysRemaining >= 0) {
            currentPeriods.push({period, daysRemaining});
        } else {
            pastPeriods.push({period, daysRemaining});
        }
    });
    
    // Render current period(s) first
    let html = '';
    currentPeriods.forEach(({period, daysRemaining}) => {
        const stats = calculatePeriodStats(period);
        const savingsRate = stats.savingsRate || 0;
        const remaining = (period.salary || 0) - stats.totalSpent;
        
        const daysBadge = `<span class="period-days-badge active">‚è∞ ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''} left</span>`;
        
        const billsPercent = period.budgets.bills > 0 ? Math.min((stats.categorySpending.bills / period.budgets.bills) * 100, 150) : 0;
        const foodPercent = period.budgets.food > 0 ? Math.min((stats.categorySpending.food / period.budgets.food) * 100, 150) : 0;
        const wantsPercent = period.budgets.wants > 0 ? Math.min((stats.categorySpending.wants / period.budgets.wants) * 100, 150) : 0;
        
        const billsOver = billsPercent > 100;
        const foodOver = foodPercent > 100;
        const wantsOver = wantsPercent > 100;
    
        // Calculate stats for previous period for comparison
        let prevPeriodStats = null;
        if (pastPeriods.length > 0) {
            const prevPeriod = pastPeriods[0].period;
            prevPeriodStats = calculatePeriodStats(prevPeriod);
        }
        
        const startDate = new Date(period.startDate);
        const daysPassed = Math.max(1, Math.ceil((today - startDate) / (1000 * 60 * 60 * 24)));
        const dailyAverage = stats.totalSpent / daysPassed;
        
        // Calculate comparison values
        let spentDiff = 0, spentDiffPercent = 0;
        let leftDiff = 0, leftDiffPercent = 0;
        let dailyDiff = 0, dailyDiffPercent = 0;
        let savingsDiff = 0;
        
        if (prevPeriodStats) {
            const prevStartDate = new Date(pastPeriods[0].period.startDate);
            const prevEndDate = new Date(pastPeriods[0].period.endDate);
            const prevDaysPassed = Math.max(1, Math.ceil((prevEndDate - prevStartDate) / (1000 * 60 * 60 * 24)));
            const prevDailyAvg = prevPeriodStats.totalSpent / prevDaysPassed;
            const prevLeft = (pastPeriods[0].period.salary || 0) - prevPeriodStats.totalSpent;
            
            spentDiff = stats.totalSpent - prevPeriodStats.totalSpent;
            spentDiffPercent = prevPeriodStats.totalSpent > 0 ? (spentDiff / prevPeriodStats.totalSpent) * 100 : 0;
            
            leftDiff = remaining - prevLeft;
            leftDiffPercent = prevLeft > 0 ? (leftDiff / prevLeft) * 100 : 0;
            
            dailyDiff = dailyAverage - prevDailyAvg;
            dailyDiffPercent = prevDailyAvg > 0 ? (dailyDiff / prevDailyAvg) * 100 : 0;
            
            savingsDiff = savingsRate - prevPeriodStats.savingsRate;
        }
        
        html += `
            <div class="period-card current-period" data-period-id="${period.id}">
                <!-- Compact Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-md); border-bottom: 2px solid rgba(96, 165, 250, 0.3);">
                    <div>
                        <h3 style="margin: 0; font-size: 1.3rem;">üìÖ Current Period</h3>
                        <div style="font-size: 0.9rem; color: var(--dark-gray); margin-top: 0.25rem;">${formatDate(period.startDate)} - ${formatDate(period.endDate)}</div>
                    </div>
                    ${daysBadge}
                </div>
                
                <!-- Main Grid: Stats + Chart -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-md);">
                    <!-- Left: Key Stats -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm);">
                        <div style="background: linear-gradient(135deg, rgba(96, 165, 250, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%); padding: var(--spacing-md); border-radius: var(--radius-md); border: 1px solid rgba(96, 165, 250, 0.3); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                            <div style="font-size: 1.2rem; color: var(--dark-gray); font-weight: 600; text-transform: uppercase;">üí∞ Spent</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-dark); margin-top: 0.25rem;">¬£${formatCurrency(stats.totalSpent)}</div>
                            <div style="font-size: 1.2rem; color: var(--dark-gray); margin-top: 0.125rem;">of ¬£${formatCurrency(period.budgets.total||0)}</div>
                            ${prevPeriodStats ? `<div style="font-size: 1.2rem; margin-top: 0.25rem; color: ${spentDiff > 0 ? 'var(--danger)' : 'var(--success)'};">${spentDiff > 0 ? '+' : ''}¬£${formatCurrency(spentDiff)} (${spentDiffPercent > 0 ? '+' : ''}${spentDiffPercent.toFixed(1)}%)</div>` : ''}
                        </div>
                        
                        <div style="background: linear-gradient(135deg, ${remaining >= 0 ? 'rgba(52, 211, 153, 0.15)' : 'rgba(248, 113, 113, 0.15)'} 0%, ${remaining >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'} 100%); padding: var(--spacing-md); border-radius: var(--radius-md); border: 1px solid ${remaining >= 0 ? 'rgba(52, 211, 153, 0.3)' : 'rgba(248, 113, 113, 0.3)'}; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                            <div style="font-size: 1.2rem; color: var(--dark-gray); font-weight: 600; text-transform: uppercase;">üíµ Left</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${remaining >= 0 ? 'var(--success)' : 'var(--danger)'}; margin-top: 0.25rem;">¬£${formatCurrency(remaining)}</div>
                            <div style="font-size: 1.2rem; color: var(--dark-gray); margin-top: 0.125rem;">of ¬£${formatCurrency(period.salary||0)}</div>
                            ${prevPeriodStats ? `<div style="font-size: 1.2rem; margin-top: 0.25rem; color: ${leftDiff > 0 ? 'var(--success)' : 'var(--danger)'};">${leftDiff > 0 ? '+' : ''}¬£${formatCurrency(leftDiff)} (${leftDiffPercent > 0 ? '+' : ''}${leftDiffPercent.toFixed(1)}%)</div>` : ''}
                        </div>
                        
                        <div style="background: linear-gradient(135deg, rgba(167, 139, 250, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%); padding: var(--spacing-md); border-radius: var(--radius-md); border: 1px solid rgba(167, 139, 250, 0.3); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                            <div style="font-size: 1.2rem; color: var(--dark-gray); font-weight: 600; text-transform: uppercase;">üìä Daily Avg</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-dark); margin-top: 0.25rem;">¬£${formatCurrency(dailyAverage)}</div>
                            <div style="font-size: 1.2rem; color: var(--dark-gray); margin-top: 0.125rem;">per day</div>
                            ${prevPeriodStats ? `<div style="font-size: 1.2rem; margin-top: 0.25rem; color: ${dailyDiff > 0 ? 'var(--danger)' : 'var(--success)'};">${dailyDiff > 0 ? '+' : ''}¬£${formatCurrency(dailyDiff)} (${dailyDiffPercent > 0 ? '+' : ''}${dailyDiffPercent.toFixed(1)}%)</div>` : ''}
                        </div>
                        
                        <div style="background: linear-gradient(135deg, rgba(52, 211, 153, 0.15) 0%, rgba(16, 185, 129, 0.1) 100%); padding: var(--spacing-md); border-radius: var(--radius-md); border: 1px solid rgba(52, 211, 153, 0.3); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                            <div style="font-size: 1.2rem; color: var(--dark-gray); font-weight: 600; text-transform: uppercase;">üíé Savings</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--success); margin-top: 0.25rem;">${savingsRate.toFixed(1)}%</div>
                            <div style="font-size: 1.2rem; color: var(--dark-gray); margin-top: 0.125rem;">${daysPassed} days</div>
                            ${prevPeriodStats ? `<div style="font-size: 1.2rem; margin-top: 0.25rem; color: ${savingsDiff > 0 ? 'var(--success)' : 'var(--danger)'};">${savingsDiff > 0 ? '+' : ''}${savingsDiff.toFixed(1)}%</div>` : ''}
                        </div>
                    </div>
                    
                    <!-- Right: Pie Chart -->
                    <div style="background: transparent; padding: var(--spacing-sm); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(59, 130, 246, 0.2);">
                        <canvas id="pie-${period.id}" width="120" height="120"></canvas>
                    </div>
                </div>
                
                <!-- Compact Progress Bars -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-sm);">
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-dark);">üìÑ Bills</span>
                            <span style="font-size: 0.75rem; font-weight: 600; color: var(--dark-gray);">¬£${stats.categorySpending.bills.toFixed(0)} <span style="color: ${billsOver ? 'var(--danger)' : 'var(--success)'};">(¬£${Math.max(0, (period.budgets.bills || 0) - stats.categorySpending.bills).toFixed(0)})</span></span>
                        </div>
                        <div style="width: 100%; height: 8px; background: var(--light-gray); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; background: ${billsOver ? 'linear-gradient(90deg, #EF4444 0%, #F87171 100%)' : 'linear-gradient(90deg, #3B82F6 0%, #60A5FA 100%)'}; width: ${billsPercent}%; transition: width 0.4s ease;"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-dark);">üçî Food</span>
                            <span style="font-size: 0.75rem; font-weight: 600; color: var(--dark-gray);">¬£${stats.categorySpending.food.toFixed(0)} <span style="color: ${foodOver ? 'var(--danger)' : 'var(--success)'};">(¬£${Math.max(0, (period.budgets.food || 0) - stats.categorySpending.food).toFixed(0)})</span></span>
                        </div>
                        <div style="width: 100%; height: 8px; background: var(--light-gray); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; background: ${foodOver ? 'linear-gradient(90deg, #EF4444 0%, #F87171 100%)' : 'linear-gradient(90deg, #10B981 0%, #34D399 100%)'}; width: ${foodPercent}%; transition: width 0.4s ease;"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-dark);">üéâ Wants</span>
                            <span style="font-size: 0.75rem; font-weight: 600; color: var(--dark-gray);">¬£${stats.categorySpending.wants.toFixed(0)} <span style="color: ${wantsOver ? 'var(--danger)' : 'var(--success)'};">(¬£${Math.max(0, (period.budgets.wants || 0) - stats.categorySpending.wants).toFixed(0)})</span></span>
                        </div>
                        <div style="width: 100%; height: 8px; background: var(--light-gray); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; background: ${wantsOver ? 'linear-gradient(90deg, #EF4444 0%, #F87171 100%)' : 'linear-gradient(90deg, #8B5CF6 0%, #A78BFA 100%)'}; width: ${wantsPercent}%; transition: width 0.4s ease;"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    // Add past periods section header if there are any
    if (pastPeriods.length > 0) {
        html += '<h3 style="color: var(--dark-gray); margin-top: var(--spacing-xl); margin-bottom: var(--spacing-md);">üìö Past Periods</h3>';
        html += '<div class="past-periods-grid">';
        
        pastPeriods.forEach(({period, daysRemaining}) => {
            const stats = calculatePeriodStats(period);
            const savingsRate = stats.savingsRate || 0;
            const remaining = (period.salary || 0) - stats.totalSpent;
            
            html += `
                <div class="period-card past-period" data-period-id="${period.id}">
                    <h3>
                        <span>${formatDate(period.startDate)} - ${formatDate(period.endDate)}</span>
                        <span class="period-days-badge complete">‚úì Complete</span>
                    </h3>
                    
                    <div class="period-summary-top">
                        <div class="period-stat-box">
                            <div class="period-stat-label">Spent</div>
                            <div class="period-stat-value">¬£${formatCurrency(stats.totalSpent)}</div>
                        </div>
                    </div>

                    <!-- Progress Bars for Past Periods -->
                    <div class="period-progress-section" style="margin-bottom: var(--spacing-sm);">
                        <div class="period-progress-item">
                            <div class="period-progress-header">
                                <span class="period-progress-label">üìÑ Bills</span>
                                <span class="period-progress-amount">¬£${formatCurrency(stats.categorySpending.bills)}</span>
                            </div>
                            <div class="period-progress-bar-container">
                                <div class="period-progress-bar ${(period.budgets.bills > 0 && stats.categorySpending.bills > period.budgets.bills) ? 'over' : 'bills'}" style="width: ${Math.min((stats.categorySpending.bills / (period.budgets.bills || 1)) * 100, 100)}%;"></div>
                            </div>
                        </div>
                        
                        <div class="period-progress-item">
                            <div class="period-progress-header">
                                <span class="period-progress-label">üçî Food</span>
                                <span class="period-progress-amount">¬£${formatCurrency(stats.categorySpending.food)}</span>
                            </div>
                            <div class="period-progress-bar-container">
                                <div class="period-progress-bar ${(period.budgets.food > 0 && stats.categorySpending.food > period.budgets.food) ? 'over' : 'food'}" style="width: ${Math.min((stats.categorySpending.food / (period.budgets.food || 1)) * 100, 100)}%;"></div>
                            </div>
                        </div>
                        
                        <div class="period-progress-item">
                            <div class="period-progress-header">
                                <span class="period-progress-label">üéâ Wants</span>
                                <span class="period-progress-amount">¬£${formatCurrency(stats.categorySpending.wants)}</span>
                            </div>
                            <div class="period-progress-bar-container">
                                <div class="period-progress-bar ${(period.budgets.wants > 0 && stats.categorySpending.wants > period.budgets.wants) ? 'over' : 'wants'}" style="width: ${Math.min((stats.categorySpending.wants / (period.budgets.wants || 1)) * 100, 100)}%;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="period-savings-indicator" style="margin-top: var(--spacing-sm);">
                        <div class="period-savings-label">Savings Rate</div>
                        <div class="period-savings-value">${savingsRate.toFixed(1)}%</div>
                        <div class="period-savings-subtext">¬£${formatCurrency(remaining)} saved</div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    container.innerHTML = html;
    
    document.querySelectorAll('.period-card').forEach(card => {
        card.addEventListener('click', function(){ viewPeriod(this.dataset.periodId); });
    });
    
    // Render pie charts for current periods
    currentPeriods.forEach(({period}) => {
        const canvas = document.getElementById(`pie-${period.id}`);
        if (canvas) {
            const stats = calculatePeriodStats(period);
            const other = stats.categorySpending.oneOff + stats.categorySpending.unexpected;
            const savings = (period.salary || 0) - stats.totalSpent;

            new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: ['Bills', 'Food', 'Wants', 'Other', 'Savings'],
                    datasets: [{
                        data: [
                            stats.categorySpending.bills,
                            stats.categorySpending.food,
                            stats.categorySpending.wants,
                            other,
                            savings
                        ],
                        backgroundColor: ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', '#22C55E'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ¬£' + formatCurrency(context.parsed);
                                }
                            }
                        }
                    }
                }
            });
        }
    });
}

        function openNewPeriodModal() {
            const periods = getPeriods();
            renderStartingBalancesFields(); // Render dynamic bank account fields
            document.getElementById('new-period-form').reset();
            const startDateInput = document.getElementById('period-start-date');
            if (periods.length > 0) {
                const lastPeriod = periods.sort((a,b) => new Date(b.endDate) - new Date(a.endDate))[0];
                const nextDay = new Date(lastPeriod.endDate);
                nextDay.setDate(nextDay.getDate() + 1);
                startDateInput.value = formatDateForInput(nextDay);
            } else {
                startDateInput.value = formatDateForInput(new Date());
            }
            openModal('new-period-modal');
        }

        function createNewPeriod(e) {
            e.preventDefault();
            const salary = parseFloat(document.getElementById('period-salary').value || 0);
            const billsBudget = document.getElementById('budget-bills-amount').value ?
                parseFloat(document.getElementById('budget-bills-amount').value) :
                (parseFloat(document.getElementById('budget-bills-percent').value || 0) / 100) * salary;
            const foodBudget = document.getElementById('budget-food-amount').value ?
                parseFloat(document.getElementById('budget-food-amount').value) :
                (parseFloat(document.getElementById('budget-food-percent').value || 0) / 100) * salary;
            const wantsBudget = document.getElementById('budget-wants-amount').value ?
                parseFloat(document.getElementById('budget-wants-amount').value) :
                (parseFloat(document.getElementById('budget-wants-percent').value || 0) / 100) * salary;

            const newPeriod = {
                id: 'period_' + Date.now(),
                startDate: document.getElementById('period-start-date').value,
                endDate: document.getElementById('period-end-date').value,
                salary: salary,
                budgets: {
                    bills: billsBudget,
                    food: foodBudget,
                    wants: wantsBudget,
                    total: (billsBudget || 0) + (foodBudget || 0) + (wantsBudget || 0)
                },
                startingBalances: getStartingBalancesFromForm(),
                expenses: [],
                owedPeople: []
            };
            const periods = getPeriods();
            periods.push(newPeriod);
            savePeriods(periods);
            closeModal('new-period-modal');
            loadPeriods();
            alert('Period created successfully! ‚úÖ');
        }

        function viewPeriod(periodId) {
            currentPeriodId = periodId;
            const period = getPeriod(periodId);
            if (!period) { alert('Period not found'); return; }
            document.getElementById('period-title').textContent = `${formatDate(period.startDate)} - ${formatDate(period.endDate)}`;
            renderNetWorthCards(period);
            renderPeriodSummary(period);
            renderPeriodDetailPieChart(period);
            renderBalancesCard(period);
            renderOwedList(period);
            renderTransactions(period);
            document.getElementById('filter-category').value = 'All';
            document.getElementById('filter-text').value = '';
            showSection('period-detail');
        }

        // ============================================
        // RENDER: Net Worth Cards (NEW)
        // ============================================
        function renderNetWorthCards(period) {
            const sb = period.startingBalances || {};
            const currentMoney = calculateTotalDebit(sb);
            const currentDebts = calculateTotalCredit(sb);
            const netWorth = calculateNetWorth(sb);

            // Calculate total owed to me
            const totalOwed = (period.owedPeople || []).reduce((sum, p) => sum + (p.amount || 0), 0);
            const netWorthOncePaid = netWorth + totalOwed;

            // Calculate remaining budgets
            const stats = calculatePeriodStats(period);
            const remainingBills = Math.max(0, (period.budgets.bills || 0) - stats.categorySpending.bills);
            const remainingFood = Math.max(0, (period.budgets.food || 0) - stats.categorySpending.food);
            const remainingWants = Math.max(0, (period.budgets.wants || 0) - stats.categorySpending.wants);
            const totalRemainingBudget = remainingBills + remainingFood + remainingWants;

            // Calculate projected net worth if all remaining budget is spent
            const projectedNetWorth = netWorth - totalRemainingBudget;

            const container = document.getElementById('networth-cards');
            container.innerHTML = `
                <div class="summary-card networth-card">
                    <h3>üí∞ Current Money</h3>
                    <div class="value">¬£${formatCurrency(currentMoney)}</div>
                    <div class="small-muted">Bank accounts</div>
                </div>
                <div class="summary-card networth-card">
                    <h3>üí≥ Current Debts</h3>
                    <div class="value">¬£${formatCurrency(currentDebts)}</div>
                    <div class="small-muted">Credit cards & loans</div>
                </div>
                <div class="summary-card networth-card">
                    <h3>üìä Net Worth</h3>
                    <div class="value ${netWorth < 0 ? 'text-danger' : ''}">¬£${formatCurrency(netWorth)}</div>
                    <div class="small-muted">Money - Debts</div>
                    <div style="font-size: 0.8rem; color: var(--dark-gray); margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--light-gray);">
                        After remaining budgets:<br>
                        <span style="font-weight: 600; color: ${projectedNetWorth < 0 ? 'var(--danger)' : 'var(--text-dark)'};">¬£${formatCurrency(projectedNetWorth)}</span>
                    </div>
                </div>
                <div class="summary-card networth-card">
                    <h3>üéØ Net Worth Once Paid</h3>
                    <div class="value">¬£${formatCurrency(netWorthOncePaid)}</div>
                    <div class="small-muted">Including owed to me</div>
                </div>
            `;
        }

        // ============================================
        // RENDER: Top summary row (5 cards)
        // ============================================
        function renderPeriodSummary(period) {
            const stats = calculatePeriodStats(period);
            const container = document.getElementById('period-summary-cards');
            const remaining = (period.salary || 0) - stats.totalSpent;

            container.innerHTML = `
                <div class="summary-card">
                    <h3>Total Spent</h3>
                    <div class="value">¬£${formatCurrency(stats.totalSpent)}</div>
                    <div class="small-muted">of ¬£${formatCurrency(period.salary||0)} salary</div>
                </div>
                <div class="summary-card">
                    <h3>Remaining</h3>
                    <div class="value">¬£${formatCurrency(remaining)}</div>
                    <div class="small-muted">${stats.savingsRate.toFixed(1)}% savings rate</div>
                </div>
                <div class="summary-card">
                    <h3>Budget Status</h3>
                    <div class="value">${stats.budgetStatus === 'over' ? '‚ö†Ô∏è Over' : '‚úÖ On Track'}</div>
                    <div class="small-muted">${stats.overUnder >= 0 ? '+' : ''}¬£${formatCurrency(stats.overUnder)}</div>
                </div>
                <div class="summary-card">
                    <h3>Unexpected</h3>
                    <div class="value">¬£${formatCurrency(stats.categorySpending.unexpected || 0)}</div>
                    <div class="small-muted">Running total</div>
                </div>
                <div class="summary-card">
                    <h3>One-off Needs</h3>
                    <div class="value">¬£${formatCurrency(stats.categorySpending.oneOff || 0)}</div>
                    <div class="small-muted">Running total</div>
                </div>
            `;

            // Render budget progress bars
            renderBudgetProgressBars(period, stats);
        }

        function renderBudgetProgressBars(period, stats) {
            const container = document.getElementById('budget-progress-bars');
            
            const budgets = [
                { 
                    name: 'Bills & Subscriptions', 
                    spent: stats.categorySpending.bills, 
                    budget: period.budgets.bills || 0,
                    emoji: 'üìÑ'
                },
                { 
                    name: 'Food', 
                    spent: stats.categorySpending.food, 
                    budget: period.budgets.food || 0,
                    emoji: 'üçî'
                },
                { 
                    name: 'Wants (Treats)', 
                    spent: stats.categorySpending.wants, 
                    budget: period.budgets.wants || 0,
                    emoji: 'üéÅ'
                }
            ];

            container.innerHTML = budgets.map(item => {
                const percentage = item.budget > 0 ? (item.spent / item.budget) * 100 : 0;
                const displayPercentage = Math.min(percentage, 100);
                const remaining = Math.max(item.budget - item.spent, 0);
                
                let colorClass = 'under-50';
                if (percentage >= 100) colorClass = 'over-100';
                else if (percentage >= 80) colorClass = 'under-100';
                else if (percentage >= 50) colorClass = 'under-80';

                return `
                    <div class="progress-item">
                        <div class="progress-header">
                            <span class="progress-label">${item.emoji} ${item.name}</span>
                            <span class="progress-values">¬£${formatCurrency(item.spent)} / ¬£${formatCurrency(item.budget)} ${percentage >= 100 ? '‚ö†Ô∏è' : ''}</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill ${colorClass}" style="width: ${displayPercentage}%">
                                ${percentage >= 10 ? percentage.toFixed(0) + '%' : ''}
                            </div>
                        </div>
                        <div style="text-align:right; margin-top:0.25rem; font-size:0.85rem; color:${percentage >= 100 ? 'var(--danger)' : 'var(--dark-gray)'}; font-weight:600;">
                            ${percentage >= 100 ? 'Over by ¬£' + formatCurrency(item.spent - item.budget) : '¬£' + formatCurrency(remaining) + ' remaining'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // Balances card (wide)
        // ============================================
        function renderBalancesCard(period) {
            const sb = period.startingBalances || {};
            const totalSavings = calculateTotalDebit(sb);
            const totalDebt = calculateTotalCredit(sb);

            const accountsHtml = bankAccounts.map(account => {
                const typeIcon = account.type === 'debit' ? 'üí≥' : account.type === 'credit' ? 'üî¥' : 'üí∞';
                return `<div class="balance-item"><strong>${typeIcon} ${escapeHtml(account.name)}</strong><div style="font-size:1.25rem;margin-top:0.25rem;">¬£${formatCurrency(sb[account.key]||0)}</div></div>`;
            }).join('');

            const el = document.getElementById('balances-card');
            el.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:var(--spacing-md);">
                    <div>
                        <h3 style="margin:0;color:var(--white);font-size:1.5rem;">üí≥ Balances & Debts</h3>
                        <div class="small-muted" style="color:rgba(255,255,255,0.9)">All accounts shown (positive = balance, credit card = owed)</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:700;font-size:1.3rem">üí∞ Savings: ¬£${formatCurrency(totalSavings)}</div>
                        <div style="font-weight:700;font-size:1.3rem">üí≥ Debt: ¬£${formatCurrency(totalDebt)}</div>
                    </div>
                </div>
                <div class="balances-grid">
                    ${accountsHtml}
                </div>
            `;
        }

        // ============================================
        // Money Owed to Me
        // ============================================
        function renderOwedList(period) {
            period.owedPeople = period.owedPeople || [];
            updatePeriodInStorage(period);

            // Calculate and display total
            const totalOwed = period.owedPeople.reduce((sum, p) => sum + (p.amount || 0), 0);
            document.getElementById('owed-total').textContent = `Total: ¬£${formatCurrency(totalOwed)}`;

            const listEl = document.getElementById('owed-list');
            if (!period.owedPeople || period.owedPeople.length === 0) {
                listEl.innerHTML = '<p style="color:var(--dark-gray);padding:var(--spacing-md);">No one owes you money yet. üí∏</p>';
            } else {
                listEl.innerHTML = period.owedPeople.map((p, idx) => `
                    <div class="owed-row" data-idx="${idx}">
                        <div style="display:flex;gap:1.5rem;align-items:center;flex:1;">
                            <div style="min-width:180px;">
                                <div class="name">${escapeHtml(p.name)}</div>
                                <div class="small-muted-dark">Editable directly</div>
                            </div>
                            <div>
                                <input type="number" step="0.01" class="owed-amount-input" value="${(p.amount || 0).toFixed(2)}" style="width:130px;padding:.5rem;border:2px solid var(--medium-gray);border-radius:var(--radius-sm);font-size:1rem;" />
                            </div>
                        </div>
                        <div class="owed-actions">
                            <button class="btn btn-sm btn-primary" data-save-owed="${idx}">üíæ Save</button>
                            <button class="btn btn-sm btn-secondary" data-edit-name="${idx}">‚úèÔ∏è Edit</button>
                            <button class="btn btn-sm btn-danger" data-delete-owed="${idx}">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            }

            document.getElementById('toggle-owed').textContent = '‚ñ≤ Hide';
            document.getElementById('owed-add-area').classList.add('hidden');

            listEl.querySelectorAll('[data-save-owed]').forEach(btn => {
                btn.addEventListener('click', function(){
                    const idx = parseInt(this.dataset.saveOwed,10);
                    const row = this.closest('.owed-row');
                    const input = row.querySelector('.owed-amount-input');
                    const val = parseFloat(input.value || 0);
                    if (isNaN(val)) { alert('Enter a valid amount'); return; }
                    period.owedPeople[idx].amount = parseFloat(val.toFixed(2));
                    updatePeriodInStorage(period);
                    renderOwedList(period);
                    renderNetWorthCards(period);
                    renderPeriodSummary(period);
                });
            });
            listEl.querySelectorAll('[data-edit-name]').forEach(btn => {
                btn.addEventListener('click', function(){
                    const idx = parseInt(this.dataset.editName,10);
                    const newName = prompt('Edit name', period.owedPeople[idx].name);
                    if (newName && newName.trim()) {
                        period.owedPeople[idx].name = newName.trim();
                        updatePeriodInStorage(period);
                        renderOwedList(period);
                        renderPeriodSummary(period);
                    }
                });
            });
            listEl.querySelectorAll('[data-delete-owed]').forEach(btn => {
                btn.addEventListener('click', function(){
                    const idx = parseInt(this.dataset.deleteOwed,10);
                    if (!confirm('Remove this person and their owed amount?')) return;
                    period.owedPeople.splice(idx,1);
                    updatePeriodInStorage(period);
                    renderOwedList(period);
                    renderNetWorthCards(period);
                    renderPeriodSummary(period);
                });
            });
        }

        document.getElementById('toggle-owed').addEventListener('click', function(){
            const list = document.getElementById('owed-list');
            const addArea = document.getElementById('owed-add-area');
            if (list.style.display === 'none' || list.classList.contains('hidden')) {
                list.classList.remove('hidden');
                addArea.classList.add('hidden');
                this.textContent = '‚ñ≤ Hide';
            } else {
                list.classList.add('hidden');
                addArea.classList.add('hidden');
                this.textContent = '‚ñº Show';
            }
        });

        document.getElementById('btn-add-owed-inline').addEventListener('click', function(){
            document.getElementById('owed-add-area').classList.toggle('hidden');
            document.getElementById('new-owed-name').focus();
        });
        document.getElementById('cancel-owed-new').addEventListener('click', function(){
            document.getElementById('owed-add-area').classList.add('hidden');
            document.getElementById('new-owed-name').value = '';
            document.getElementById('new-owed-amount').value = '';
        });
        document.getElementById('save-owed-new').addEventListener('click', function(){
            const name = document.getElementById('new-owed-name').value.trim();
            const amt = parseFloat(document.getElementById('new-owed-amount').value || 0);
            if (!name) { alert('Enter a name'); return; }
            if (isNaN(amt)) { alert('Enter a valid amount'); return; }
            const period = getPeriod(currentPeriodId);
            period.owedPeople = period.owedPeople || [];
            period.owedPeople.push({ name: name, amount: parseFloat(amt.toFixed(2)) });
            updatePeriodInStorage(period);
            document.getElementById('new-owed-name').value = '';
            document.getElementById('new-owed-amount').value = '';
            document.getElementById('owed-add-area').classList.add('hidden');
            renderOwedList(period);
            renderNetWorthCards(period);
            renderPeriodSummary(period);
        });

        // ============================================
        // TRANSACTIONS
        // ============================================
        function renderTransactions(period) {
            const tbody = document.getElementById('transactions-tbody');
            const filterCat = document.getElementById('filter-category').value || 'All';
            const filterText = (document.getElementById('filter-text').value || '').toLowerCase().trim();

            let expenses = (period.expenses || []).slice().sort((a,b) => new Date(b.date) - new Date(a.date));
            if (filterCat !== 'All') expenses = expenses.filter(e => e.category === filterCat);
            if (filterText) expenses = expenses.filter(e => (e.description || '').toLowerCase().includes(filterText) || (e.notes || '').toLowerCase().includes(filterText));

            if (!expenses || expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--dark-gray);padding:var(--spacing-lg);">No transactions match your filter üîç</td></tr>';
                return;
            }

            tbody.innerHTML = expenses.map(expense => {
                const amount = (expense.myShare !== undefined && expense.myShare !== null) ? expense.myShare : expense.amount;
                const isIncome = expense.category === 'Income';
                const amountClass = isIncome ? 'text-success' : 'text-danger';
                const amountSign = isIncome ? '+' : '-';
                return `
                    <tr>
                        <td><strong>${formatDate(expense.date)}</strong></td>
                        <td>
                            <strong>${escapeHtml(expense.description)}</strong>
                            ${expense.notes ? `<br><small style="color:var(--dark-gray);">${escapeHtml(expense.notes)}</small>` : ''}
                        </td>
                        <td>
                            <span style="display:inline-block;padding:.35rem .75rem;border-radius:var(--radius-sm);background:var(--light-blue);font-weight:700;color:var(--primary-blue);">${expense.category}</span>
                            <br><small style="color:var(--dark-gray);font-weight:500;">${expense.subcategory || ''}</small>
                        </td>
                        <td class="${amountClass}">
                            <strong style="font-size:1.1rem;">${amountSign}¬£${formatCurrency(amount)}</strong>
                            ${(expense.sharedAllocations && expense.sharedAllocations.length>0) ? `<br><small style="color:var(--dark-gray);">üìä Split</small>` : ''}
                        </td>
                        <td><span style="font-weight:600;">${expense.paymentMethod}</span></td>
                        <td>
                            <div style="display:flex;gap:.5rem">
                                <button class="btn btn-sm btn-secondary" data-edit-expense="${expense.id}">‚úèÔ∏è Edit</button>
                                <button class="btn btn-sm btn-danger" data-delete-expense="${expense.id}">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.querySelectorAll('[data-edit-expense]').forEach(btn => btn.addEventListener('click', function(){ editExpense(this.dataset.editExpense); }));
            tbody.querySelectorAll('[data-delete-expense]').forEach(btn => btn.addEventListener('click', function(){ deleteExpense(this.dataset.deleteExpense); }));
        }

        document.getElementById('filter-category').addEventListener('change', function(){
            const period = getPeriod(currentPeriodId);
            if (period) renderTransactions(period);
        });
        document.getElementById('filter-text').addEventListener('input', function(){
            const period = getPeriod(currentPeriodId);
            if (period) renderTransactions(period);
        });

        // ============================================
        // SHARED CONTROLS RENDERING
        // ============================================
        function renderSharedControls(period, expense) {
            period.owedPeople = period.owedPeople || [];
            const tbody = document.getElementById('expense-shared-body');
            if (!period.owedPeople || period.owedPeople.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="color:var(--dark-gray);padding:var(--spacing-md);">No people added yet. Use "Add new person" to create. üë•</td></tr>';
                return;
            }
            const allocations = {};
            if (expense && Array.isArray(expense.sharedAllocations)) {
                expense.sharedAllocations.forEach(a => {
                    if (a && (a.idx !== undefined)) allocations[a.idx] = a.amount;
                });
            }

            tbody.innerHTML = period.owedPeople.map((p, idx) => {
                const currentOwes = (p.amount || 0).toFixed(2);
                const prefill = allocations[idx] !== undefined ? parseFloat(allocations[idx]).toFixed(2) : '';
                return `
                    <tr data-shared-idx="${idx}">
                        <td><strong>${escapeHtml(p.name)}</strong></td>
                        <td><strong style="color:var(--primary-blue);">¬£${currentOwes}</strong></td>
                        <td><input type="number" step="0.01" id="shared-owed-${idx}" placeholder="0.00" value="${prefill}"></td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // EXPENSE MANAGEMENT
        // ============================================
        function openAddExpenseModal() {
            editingExpenseId = null;
            document.getElementById('expense-modal-title').textContent = 'Add Expense';
            document.getElementById('expense-form').reset();
            document.getElementById('expense-id').value = '';
            document.getElementById('expense-date').value = formatDateForInput(new Date());
            document.getElementById('income-controls').style.display = 'none';
            populatePaymentMethods(); // Populate dynamic bank accounts
            populatePeopleAndSharedForPeriod();
            openModal('expense-modal');
        }

        function editExpense(expenseId) {
            const period = getPeriod(currentPeriodId);
            const expense = period.expenses.find(e => e.id === expenseId);
            if (!expense) { alert('Expense not found!'); return; }
            editingExpenseId = expenseId;
            document.getElementById('expense-modal-title').textContent = 'Edit Expense';
            document.getElementById('expense-id').value = expense.id;
            document.getElementById('expense-date').value = expense.date;
            document.getElementById('expense-amount').value = expense.amount;
            document.getElementById('expense-description').value = expense.description;
            document.getElementById('expense-category').value = expense.category;
            updateSubcategories();
            document.getElementById('expense-subcategory').value = expense.subcategory;
            populatePaymentMethods(); // Populate dynamic bank accounts
            document.getElementById('expense-payment').value = expense.paymentMethod;
            document.getElementById('expense-notes').value = expense.notes || '';
            populatePeopleAndSharedForPeriod(expense);
            if (expense.category === 'Income') {
                document.getElementById('income-controls').style.display = 'flex';
                if (expense.receivedFromIdx !== undefined) document.getElementById('expense-received-from').value = expense.receivedFromIdx;
                if (expense.applyToDebt) document.getElementById('expense-apply-debt').value = expense.applyToDebt;
            } else document.getElementById('income-controls').style.display = 'none';
            openModal('expense-modal');
        }

        function saveExpense(e) {
            e.preventDefault();
            const period = getPeriod(currentPeriodId);
            if (!period) { alert('No period selected'); return; }

            const expenseId = editingExpenseId || 'expense_' + Date.now();
            const amount = parseFloat(document.getElementById('expense-amount').value || 0);
            const category = document.getElementById('expense-category').value;
            const paymentMethod = document.getElementById('expense-payment').value;

            const expense = {
                id: expenseId,
                date: document.getElementById('expense-date').value,
                amount: amount,
                description: document.getElementById('expense-description').value,
                category: category,
                subcategory: document.getElementById('expense-subcategory').value,
                paymentMethod: paymentMethod,
                notes: document.getElementById('expense-notes').value,
                sharedAllocations: []
            };

            // Handle shared expenses (people who owe you money)
            period.owedPeople = period.owedPeople || [];
            let totalOwedFromInputs = 0;
            const allocations = [];
            for (let i = 0; i < period.owedPeople.length; i++) {
                const input = document.getElementById(`shared-owed-${i}`);
                if (!input) continue;
                const v = input.value;
                const val = v === '' ? 0 : parseFloat(v || 0);
                if (isNaN(val)) { alert('One of the shared amounts is not valid'); return; }
                if (val > 0) {
                    period.owedPeople[i].amount = parseFloat(((period.owedPeople[i].amount || 0) + val).toFixed(2));
                    allocations.push({ idx: i, name: period.owedPeople[i].name, amount: parseFloat(val.toFixed(2)) });
                    totalOwedFromInputs += val;
                }
            }

            expense.sharedAllocations = allocations;
            const myShare = parseFloat((amount - totalOwedFromInputs).toFixed(2));
            expense.myShare = isNaN(myShare) ? amount : myShare;

            // Handle income that reduces debt
            if (category === 'Income') {
                const recIdx = document.getElementById('expense-received-from').value;
                const applyVal = document.getElementById('expense-apply-debt').value;
                const applyAmount = applyVal ? parseFloat(applyVal) : null;
                period.owedPeople = period.owedPeople || [];
                if (recIdx) {
                    const idx = parseInt(recIdx,10);
                    const reduceBy = applyAmount || amount;
                    if (period.owedPeople[idx]) {
                        period.owedPeople[idx].amount = parseFloat(((period.owedPeople[idx].amount || 0) - reduceBy).toFixed(2));
                        if (period.owedPeople[idx].amount <= 0) {
                            period.owedPeople.splice(idx,1);
                        }
                        expense.receivedFromIdx = idx;
                    }
                }
                if (applyAmount) expense.applyToDebt = applyAmount;
            }

            // Update bank balances - use myShare (what you actually paid) not total amount
            const sb = period.startingBalances || {};
            function adjustAccount(method, delta) {
                if (!sb) return;
                const account = bankAccounts.find(acc => acc.name === method);
                if (account) {
                    sb[account.key] = parseFloat(((sb[account.key] || 0) + delta).toFixed(2));
                }
            }

            if (category === 'Income') {
                // Income increases account balance (add full amount)
                adjustAccount(paymentMethod, amount);
            } else {
                // Expense decreases balance - use FULL amount (not myShare) because you paid the full amount
                const account = bankAccounts.find(acc => acc.name === paymentMethod);
                if (account && (account.type === 'credit' || account.type === 'loan')) {
                    // Credit cards and loans: increase debt by full amount
                    adjustAccount(paymentMethod, amount);
                } else {
                    // Debit/cash: reduce balance by full amount
                    adjustAccount(paymentMethod, -amount);
                }
            }

            // Save the expense to the period
            const periodObj = getPeriod(currentPeriodId);
            if (!periodObj) { alert('Current period missing'); return; }
            
            // Copy updated balances back to period
            periodObj.startingBalances = sb;
            periodObj.owedPeople = period.owedPeople;
            
            if (editingExpenseId) {
                const idx = periodObj.expenses.findIndex(x => x.id === expenseId);
                if (idx !== -1) periodObj.expenses[idx] = expense;
            } else {
                periodObj.expenses.push(expense);
            }

            updatePeriodInStorage(periodObj);
            closeModal('expense-modal');
            viewPeriod(currentPeriodId);
        }

        function openEditBalancesModal() {
            const period = getPeriod(currentPeriodId);
            if (!period) { alert('No period selected'); return; }

            renderEditBalancesFields(); // Render dynamic bank account fields

            const sb = period.startingBalances || {};
            bankAccounts.forEach(account => {
                const input = document.getElementById(`edit-${account.key}`);
                if (input) {
                    input.value = (sb[account.key] || 0).toFixed(2);
                }
            });

            openModal('edit-balances-modal');
        }

        function saveBalanceEdits(e) {
            e.preventDefault();
            const period = getPeriod(currentPeriodId);
            if (!period) { alert('No period selected'); return; }

            period.startingBalances = getStartingBalancesFromEditForm();

            updatePeriodInStorage(period);
            closeModal('edit-balances-modal');
            viewPeriod(currentPeriodId);
            alert('Balances updated successfully! ‚úÖ');
        }

        function deleteExpense(expenseId) {
            if (!confirm('Are you sure you want to delete this expense?')) return;
            const period = getPeriod(currentPeriodId);
            const expense = period.expenses.find(e => e.id === expenseId);
            if (!expense) return;

            // Reverse the shared allocations (reduce what people owe you)
            if (expense.sharedAllocations && expense.sharedAllocations.length > 0) {
                period.owedPeople = period.owedPeople || [];
                expense.sharedAllocations.forEach(alloc => {
                    if (period.owedPeople[alloc.idx]) {
                        period.owedPeople[alloc.idx].amount = parseFloat(((period.owedPeople[alloc.idx].amount || 0) - alloc.amount).toFixed(2));
                        // Remove if they now owe nothing or negative
                        if (period.owedPeople[alloc.idx].amount <= 0) {
                            period.owedPeople.splice(alloc.idx, 1);
                        }
                    }
                });
            }

            // Reverse the balance changes
            const sb = period.startingBalances || {};
            function adjustAccount(method, delta) {
                if (!sb) return;
                const account = bankAccounts.find(acc => acc.name === method);
                if (account) {
                    sb[account.key] = parseFloat(((sb[account.key] || 0) + delta).toFixed(2));
                }
            }

            const amount = expense.amount;
            const category = expense.category;
            const paymentMethod = expense.paymentMethod;

            if (category === 'Income') {
                // Reverse income: subtract from account
                adjustAccount(paymentMethod, -amount);
                // If it was applied to someone's debt, add it back
                if (expense.receivedFromIdx !== undefined) {
                    const idx = expense.receivedFromIdx;
                    const reduceBy = expense.applyToDebt || amount;
                    if (period.owedPeople[idx]) {
                        period.owedPeople[idx].amount = parseFloat(((period.owedPeople[idx].amount || 0) + reduceBy).toFixed(2));
                    }
                }
            } else {
                // Reverse expense
                const account = bankAccounts.find(acc => acc.name === paymentMethod);
                if (account && (account.type === 'credit' || account.type === 'loan')) {
                    // Credit cards and loans: decrease debt
                    adjustAccount(paymentMethod, -amount);
                } else {
                    // Debit/cash: add balance back
                    adjustAccount(paymentMethod, amount);
                }
            }

            period.startingBalances = sb;
            period.expenses = period.expenses.filter(e => e.id !== expenseId);
            updatePeriodInStorage(period);
            viewPeriod(currentPeriodId);
        }

        function updateSubcategories() {
            const category = document.getElementById('expense-category').value;
            const subcategorySelect = document.getElementById('expense-subcategory');
            subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            if (category && subcategories[category]) {
                subcategories[category].forEach(sub => {
                    const opt = document.createElement('option'); opt.value = sub; opt.textContent = sub; subcategorySelect.appendChild(opt);
                });
            }
            if (category === 'Income') document.getElementById('income-controls').style.display = 'flex';
            else document.getElementById('income-controls').style.display = 'none';
        }

        document.getElementById('btn-add-person').addEventListener('click', function(){
            const name = document.getElementById('expense-add-person').value.trim();
            if (!name) { alert('Enter a name to add'); return; }
            const period = getPeriod(currentPeriodId);
            period.owedPeople = period.owedPeople || [];
            period.owedPeople.push({ name: name, amount: 0 });
            updatePeriodInStorage(period);
            populatePeopleAndSharedForPeriod();
            document.getElementById('expense-add-person').value = '';
        });

        function populatePeopleAndSharedForPeriod(expense) {
            const period = getPeriod(currentPeriodId);
            if (!period) return;
            renderSharedControls(period, expense);
            const received = document.getElementById('expense-received-from');
            if (received) {
                received.innerHTML = '<option value="">Select person</option>';
                (period.owedPeople || []).forEach((p, idx) => {
                    const o = document.createElement('option');
                    o.value = idx;
                    o.textContent = `${p.name} (¬£${formatCurrency(p.amount||0)})`;
                    received.appendChild(o);
                });
            }
        }

        // ============================================
        // CALCULATIONS
        // ============================================
        function calculatePeriodStats(period) {
            const categorySpending = { bills:0, food:0, wants:0, oneOff:0, unexpected:0 };
            let totalIncome = 0;
            (period.expenses || []).forEach(expense => {
                const amount = (expense.myShare !== undefined && expense.myShare !== null) ? expense.myShare : expense.amount;
                if (expense.category === 'Income') totalIncome += amount;
                else if (expense.category === 'Bills/Subscriptions') categorySpending.bills += amount;
                else if (expense.category === 'Food') categorySpending.food += amount;
                else if (expense.category === 'Wants') categorySpending.wants += amount;
                else if (expense.category === 'One-off Needs') categorySpending.oneOff += amount;
                else if (expense.category === 'Unexpected') categorySpending.unexpected += amount;
            });
            const totalSpent = categorySpending.bills + categorySpending.food + categorySpending.wants + categorySpending.oneOff + categorySpending.unexpected;
            const totalBudget = period.budgets.total || 0;
            const overUnder = totalBudget - (categorySpending.bills + categorySpending.food + categorySpending.wants);
            let budgetStatus = 'good';
            if (overUnder < 0) budgetStatus = 'over';
            else if (overUnder < totalBudget * 0.1) budgetStatus = 'warning';
            const savingsRate = period.salary ? ((period.salary - totalSpent) / period.salary) * 100 : 0;
            return {
                categorySpending,
                totalSpent,
                totalBudget,
                overUnder,
                budgetStatus,
                savingsRate,
                totalIncome
            };
        }

        // ============================================
        // FULL SUMMARY
        // ============================================
       function loadFullSummary() {
    const periods = getPeriods();
    const container = document.getElementById('full-summary-content');
    if (periods.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--dark-gray);padding:var(--spacing-xl);">No periods to summarize yet. üìä</p>';
        return;
    }
    
    // Sort periods by date
    periods.sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
    
    container.innerHTML = `
    <!-- Filter Controls -->
    <div style="background:var(--white); padding:var(--spacing-lg); border-radius:var(--radius-lg); box-shadow:var(--shadow-md); margin-bottom:var(--spacing-lg); border: 1px solid var(--medium-gray);">
        <div style="display:flex; gap:var(--spacing-md); align-items:end; flex-wrap:wrap;">
            <div style="flex:1; min-width:200px; position:relative;">
                <label style="display:block; font-weight:600; color:var(--dark-blue); margin-bottom:0.5rem;">üìÖ Filter by Period</label>
                <div class="multi-select-wrapper">
                    <div id="summary-period-filter" class="multi-select-trigger" style="width:100%; padding:var(--spacing-sm); border:2px solid var(--medium-gray); border-radius:var(--radius-md); background:var(--white); color:var(--text-dark); cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                        <span id="period-filter-display">All Periods</span>
                        <span style="margin-left:auto;">‚ñº</span>
                    </div>
                    <div id="period-filter-dropdown" class="multi-select-dropdown" style="display:none; position:absolute; top:100%; left:0; right:0; background:var(--white); border:2px solid var(--medium-gray); border-radius:var(--radius-md); margin-top:0.25rem; max-height:300px; overflow-y:auto; z-index:1000; box-shadow:var(--shadow-md);">
                        <div style="padding:var(--spacing-sm); border-bottom:1px solid var(--light-gray);">
                            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer; padding:0.25rem;">
                                <input type="checkbox" id="select-all-periods" style="cursor:pointer;">
                                <span style="font-weight:600; color:var(--text-dark);">All Periods</span>
                            </label>
                        </div>
                        <div id="period-checkboxes-container">
                            ${periods.map(p => `
                                <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer; padding:var(--spacing-sm); border-bottom:1px solid var(--light-gray);" class="period-checkbox-label">
                                    <input type="checkbox" class="period-checkbox" value="${p.id}" style="cursor:pointer;">
                                    <span style="color:var(--text-dark);">${formatDate(p.startDate)} - ${formatDate(p.endDate)}</span>
                                </label>
                            `).join('')}
                        </div>
                        <div style="padding:var(--spacing-sm); border-top:2px solid var(--medium-gray); display:flex; gap:var(--spacing-sm); background:var(--light-gray);">
                            <button id="clear-all-periods" style="flex:1; padding:0.5rem; border:1px solid var(--medium-gray); border-radius:var(--radius-md); background:var(--card-bg); color:var(--text-dark); cursor:pointer; font-size:0.9em;">Clear All</button>
                        </div>
                    </div>
                </div>
            </div>
            <div style="flex:1; min-width:200px;">
                <label style="display:block; font-weight:600; color:var(--dark-blue); margin-bottom:0.5rem;">üìÖ Or Date Range</label>
                <div style="display:flex; gap:0.5rem; align-items:center;">
                    <input type="date" id="summary-start-date" style="flex:1; padding:var(--spacing-sm); border:2px solid var(--medium-gray); border-radius:var(--radius-md); background:var(--white); color:var(--text-dark);">
                    <span style="color:var(--text-dark);">to</span>
                    <input type="date" id="summary-end-date" style="flex:1; padding:var(--spacing-sm); border:2px solid var(--medium-gray); border-radius:var(--radius-md); background:var(--white); color:var(--text-dark);">
                </div>
            </div>
            <button class="btn btn-primary" id="apply-summary-filter">Apply Filter</button>
            <button class="btn btn-secondary" id="reset-summary-filter">Reset</button>
        </div>
    </div>
    
    <!-- Summary Stats Cards -->
    <div id="summary-stats-cards"></div>
    
    <!-- Charts Section - Fixed Grid -->
    <!-- Replace the Full Summary charts section (around line 950 in your HTML) with this fixed version -->
<!-- Charts Section - Fixed Grid with overflow handling -->
<div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:var(--spacing-lg); margin-bottom:var(--spacing-lg);">
    <!-- Category Breakdown Pie Chart -->
    <div style="background:var(--white); padding:var(--spacing-lg); border-radius:var(--radius-lg); box-shadow:var(--shadow-md); border: 1px solid var(--medium-gray); overflow:hidden;">
        <h3 style="color:var(--dark-blue); margin-bottom:var(--spacing-md);">ü•ß Spending by Category</h3>
        <div style="height:300px; position:relative;">
            <canvas id="category-pie-chart"></canvas>
        </div>
    </div>
    
    <!-- Weekly Spending Bar Chart -->
    <div style="background:var(--card-bg); padding:var(--spacing-lg); border-radius:var(--radius-lg); box-shadow:var(--shadow-md); border: 1px solid var(--medium-gray); overflow:hidden;">
        <h3 style="color:var(--dark-blue); margin-bottom:var(--spacing-md);">üìä Weekly Spending Breakdown</h3>
        <div style="display:flex; gap:var(--spacing-sm); margin-bottom:var(--spacing-md); flex-wrap:wrap;">
            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                <input type="checkbox" id="toggle-weekly-bills" checked> 
                <span style="color:#60A5FA; font-weight:600;">üìÑ Bills</span>
            </label>
            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                <input type="checkbox" id="toggle-weekly-wants" checked> 
                <span style="color:#A78BFA; font-weight:600;">üéÅ Wants</span>
            </label>
            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                <input type="checkbox" id="toggle-weekly-food" checked> 
                <span style="color:#34D399; font-weight:600;">üçî Food</span>
            </label>
            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                <input type="checkbox" id="toggle-weekly-needs"> 
                <span style="color:#FBBF24; font-weight:600;">üõí Needs</span>
            </label>
            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                <input type="checkbox" id="toggle-weekly-unexpected"> 
                <span style="color:#F87171; font-weight:600;">‚ö†Ô∏è Unexpected</span>
            </label>
        </div>
        <div style="height:300px; position:relative;">
            <canvas id="weekly-spending-chart"></canvas>
        </div>
    </div>
</div>

<!-- Period Comparison Table -->
<div style="background:var(--white); padding:var(--spacing-lg); border-radius:var(--radius-lg); box-shadow:var(--shadow-md); margin-bottom:var(--spacing-lg); border: 1px solid var(--medium-gray);">
    <h3 style="color:var(--dark-blue); margin-bottom:var(--spacing-md);">üìà Period Comparison</h3>
    <div class="table-container">
        <table id="period-comparison-table">
            <thead>
                <tr>
                    <th>Period</th>
                    <th>Spent</th>
                    <th>Saved</th>
                    <th>Save %</th>
                    <th>Bills</th>
                    <th>Food</th>
                    <th>Wants</th>
                    <th>Net Worth</th>
                </tr>
            </thead>
            <tbody id="period-comparison-tbody"></tbody>
        </table>
    </div>
</div>

<!-- Net Worth Progression -->
<div style="background:var(--white); padding:var(--spacing-lg); border-radius:var(--radius-lg); box-shadow:var(--shadow-md); margin-bottom:var(--spacing-lg); border: 1px solid var(--medium-gray); overflow:hidden;">
    <h3 style="color:var(--dark-blue); margin-bottom:var(--spacing-md);">üìà Net Worth Progression</h3>
    <div style="display:flex; gap:var(--spacing-md);">
        <div style="flex: 0 0 50%; height:300px; overflow-y:auto; border:1px solid var(--medium-gray); border-radius:var(--radius-md);">
            <table style="width:100%; border-collapse:collapse;">
                <thead style="position:sticky; top:0; background:#3B82F6; z-index:1;">
                    <tr>
                        <th style="padding:var(--spacing-sm); text-align:left; border-bottom:2px solid var(--medium-gray); color:white;">Period</th>
                        <th style="padding:var(--spacing-sm); text-align:right; border-bottom:2px solid var(--medium-gray); color:white;">Net Worth</th>
                        <th style="padding:var(--spacing-sm); text-align:right; border-bottom:2px solid var(--medium-gray); color:white;">NW Change</th>
                        <th style="padding:var(--spacing-sm); text-align:right; border-bottom:2px solid var(--medium-gray); color:white;">NW + Owed</th>
                    </tr>
                </thead>
                <tbody id="networth-table-body">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>
        <div style="flex: 0 0 calc(50% - var(--spacing-md)); height:300px; position:relative;">
            <canvas id="networth-chart"></canvas>
        </div>
    </div>
</div>

<!-- Savings Rate Over Time -->
<div style="background:var(--white); padding:var(--spacing-lg); border-radius:var(--radius-lg); box-shadow:var(--shadow-md); margin-bottom:var(--spacing-lg); border: 1px solid var(--medium-gray); overflow:hidden;">
    <h3 style="color:var(--dark-blue); margin-bottom:var(--spacing-md);">üíé Savings Rate Over Time</h3>
    <div style="display:flex; gap:var(--spacing-md);">
        <div style="flex: 0 0 66.666%; height:300px; position:relative;">
            <canvas id="savings-rate-chart"></canvas>
        </div>
        <div style="flex: 0 0 calc(33.333% - var(--spacing-md)); height:300px; overflow-y:auto; border:1px solid var(--medium-gray); border-radius:var(--radius-md);">
            <table style="width:100%; border-collapse:collapse;">
                <thead style="position:sticky; top:0; background:#3B82F6; z-index:1;">
                    <tr>
                        <th style="padding:var(--spacing-sm); text-align:left; border-bottom:2px solid var(--medium-gray); color:white;">Period</th>
                        <th style="padding:var(--spacing-sm); text-align:right; border-bottom:2px solid var(--medium-gray); color:white;">Savings Rate</th>
                    </tr>
                </thead>
                <tbody id="savings-rate-table-body">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Daily Spending Chart -->
<div style="background:var(--white); padding:var(--spacing-lg); border-radius:var(--radius-lg); box-shadow:var(--shadow-md); margin-bottom:var(--spacing-lg); border: 1px solid var(--medium-gray); overflow:hidden;">
    <h3 style="color:var(--dark-blue); margin-bottom:var(--spacing-md);">üìä Daily Spending Trends</h3>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--spacing-md); flex-wrap:wrap; gap:var(--spacing-sm);">
        <div style="display:flex; gap:var(--spacing-xs); flex-wrap:wrap; align-items:center;">
            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                <input type="checkbox" id="toggle-cumulative-summary" checked> 
                <span style="font-weight:600; color:var(--dark-blue);">Cumulative</span>
            </label>
        </div>
        <div style="display:flex; gap:var(--spacing-sm); flex-wrap:wrap;">
            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                <input type="checkbox" id="toggle-bills-summary" checked> 
                <span style="color:#3B82F6; font-weight:600;">üìÑ Bills</span>
            </label>
            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                <input type="checkbox" id="toggle-wants-summary" checked> 
                <span style="color:#8B5CF6; font-weight:600;">üéÅ Wants</span>
            </label>
            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                <input type="checkbox" id="toggle-food-summary" checked> 
                <span style="color:#10B981; font-weight:600;">üçî Food</span>
            </label>
            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                <input type="checkbox" id="toggle-needs-summary"> 
                <span style="color:#F59E0B; font-weight:600;">üõí Needs</span>
            </label>
            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                <input type="checkbox" id="toggle-unexpected-summary"> 
                <span style="color:#EF4444; font-weight:600;">‚ö†Ô∏è Unexpected</span>
            </label>
        </div>
    </div>
    <div style="height:400px; position:relative;">
        <canvas id="daily-spending-chart"></canvas>
    </div>
</div>

<!-- Top Expenses Table -->
<div style="background:var(--card-bg); padding:var(--spacing-lg); border-radius:var(--radius-lg); box-shadow:var(--shadow-md); margin-bottom:var(--spacing-lg); border: 1px solid var(--medium-gray); overflow:hidden;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--spacing-md);">
        <h3 style="color:var(--dark-blue); margin:0;">üí∞ Top 10 Expenses</h3>
        <select id="top-expenses-filter" style="padding:0.5rem 1rem; border:2px solid var(--medium-gray); border-radius:var(--radius-md); background:var(--card-bg-light); color:var(--text-dark);">
            <option value="all">All Categories</option>
            <option value="Bills/Subscriptions">Bills</option>
            <option value="Wants">Wants</option>
            <option value="Food">Food</option>
            <option value="One-off Needs">Needs</option>
            <option value="Unexpected">Unexpected</option>
        </select>
    </div>
    <div class="table-container">
        <table id="top-expenses-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody id="top-expenses-tbody"></tbody>
        </table>
    </div>
</div>
    
    <!-- Subcategory Breakdown -->
    <div style="background:var(--white); padding:var(--spacing-lg); border-radius:var(--radius-lg); box-shadow:var(--shadow-md); margin-bottom:var(--spacing-lg); border: 1px solid var(--medium-gray);">
        <h3 style="color:var(--dark-blue); margin-bottom:var(--spacing-md);">üè∑Ô∏è Spending by Subcategory</h3>
        <div id="subcategory-breakdown"></div>
    </div>
`;
    
    // Initialize with all data
    renderSummaryData(periods);

    // Multi-select dropdown functionality
    const filterTrigger = document.getElementById('summary-period-filter');
    const filterDropdown = document.getElementById('period-filter-dropdown');
    const filterDisplay = document.getElementById('period-filter-display');
    const selectAllCheckbox = document.getElementById('select-all-periods');
    const clearAllButton = document.getElementById('clear-all-periods');
    const periodCheckboxes = document.querySelectorAll('.period-checkbox');

    // Toggle dropdown
    filterTrigger.addEventListener('click', (e) => {
        e.stopPropagation();
        filterDropdown.style.display = filterDropdown.style.display === 'none' ? 'block' : 'none';
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!filterTrigger.contains(e.target) && !filterDropdown.contains(e.target)) {
            filterDropdown.style.display = 'none';
        }
    });

    // Update display text
    function updateFilterDisplay() {
        const checked = Array.from(periodCheckboxes).filter(cb => cb.checked);
        if (checked.length === 0 || checked.length === periodCheckboxes.length) {
            filterDisplay.textContent = 'All Periods';
            selectAllCheckbox.checked = true;
        } else if (checked.length === 1) {
            const label = checked[0].parentElement.querySelector('span').textContent;
            filterDisplay.textContent = label;
            selectAllCheckbox.checked = false;
        } else {
            filterDisplay.textContent = `${checked.length} Periods Selected`;
            selectAllCheckbox.checked = false;
        }
    }

    // Select/Deselect all
    selectAllCheckbox.addEventListener('change', function() {
        periodCheckboxes.forEach(cb => cb.checked = this.checked);
        updateFilterDisplay();
    });

    // Clear all
    clearAllButton.addEventListener('click', () => {
        periodCheckboxes.forEach(cb => cb.checked = false);
        selectAllCheckbox.checked = false;
        updateFilterDisplay();
    });

    // Individual checkbox change
    periodCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            updateFilterDisplay();
            // Check if all are selected
            const allChecked = Array.from(periodCheckboxes).every(checkbox => checkbox.checked);
            selectAllCheckbox.checked = allChecked;
        });
    });

    // Initialize - check all by default
    selectAllCheckbox.checked = true;
    periodCheckboxes.forEach(cb => cb.checked = true);
    updateFilterDisplay();

    // Event listeners for filters
    document.getElementById('apply-summary-filter').addEventListener('click', applySummaryFilter);
    document.getElementById('reset-summary-filter').addEventListener('click', () => {
        selectAllCheckbox.checked = true;
        periodCheckboxes.forEach(cb => cb.checked = true);
        updateFilterDisplay();
        document.getElementById('summary-start-date').value = '';
        document.getElementById('summary-end-date').value = '';
        renderSummaryData(periods);
    });
    
    ['toggle-cumulative-summary', 'toggle-bills-summary', 'toggle-wants-summary', 'toggle-food-summary', 'toggle-needs-summary', 'toggle-unexpected-summary'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => renderDailySpendingChart(getFilteredPeriods()));
    });

    ['toggle-weekly-bills', 'toggle-weekly-wants', 'toggle-weekly-food', 'toggle-weekly-needs', 'toggle-weekly-unexpected'].forEach(id => {
    const elem = document.getElementById(id);
    if (elem) {
        elem.addEventListener('change', () => renderWeeklySpendingChart(getFilteredPeriods()));
    }
});
}

function applySummaryFilter() {
    const periodCheckboxes = document.querySelectorAll('.period-checkbox');
    const selectedPeriodIds = Array.from(periodCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    const startDate = document.getElementById('summary-start-date').value;
    const endDate = document.getElementById('summary-end-date').value;

    let filtered = getPeriods();

    if (selectedPeriodIds.length > 0 && selectedPeriodIds.length < periodCheckboxes.length) {
        filtered = filtered.filter(p => selectedPeriodIds.includes(p.id));
    } else if (startDate && endDate) {
        filtered = filtered.filter(p => {
            const pStart = new Date(p.startDate);
            const pEnd = new Date(p.endDate);
            const fStart = new Date(startDate);
            const fEnd = new Date(endDate);
            return (pStart <= fEnd && pEnd >= fStart);
        });
    }

    renderSummaryData(filtered);
}

function getFilteredPeriods() {
    const periodCheckboxes = document.querySelectorAll('.period-checkbox');
    const selectedPeriodIds = Array.from(periodCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    const startDate = document.getElementById('summary-start-date').value;
    const endDate = document.getElementById('summary-end-date').value;

    let filtered = getPeriods();

    if (selectedPeriodIds.length > 0 && selectedPeriodIds.length < periodCheckboxes.length) {
        filtered = filtered.filter(p => selectedPeriodIds.includes(p.id));
    } else if (startDate && endDate) {
        filtered = filtered.filter(p => {
            const pStart = new Date(p.startDate);
            const pEnd = new Date(p.endDate);
            const fStart = new Date(startDate);
            const fEnd = new Date(endDate);
            return (pStart <= fEnd && pEnd >= fStart);
        });
    }

    return filtered;
}

function calculateNoSpendDays(periods) {
    if (periods.length === 0) return '0/0';
    
    // Get all dates in the selected periods
    const allDates = new Set();
    const spendDates = new Set();
    
    periods.forEach(period => {
        const startDate = new Date(period.startDate);
        const endDate = new Date(period.endDate);
        
        // Add only dates up to today
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const currentDate = new Date(startDate);
        const lastDate = endDate < today ? endDate : today;
        
        while (currentDate <= lastDate) {
            allDates.add(formatDateForInput(currentDate));
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        // Track dates with Wants or Food expenses (no-spend means no Wants or Food)
        (period.expenses || []).forEach(expense => {
            if (expense.category === 'Wants' || expense.category === 'Food') {
                spendDates.add(expense.date);
            }
        });
    });
    
    const totalDays = allDates.size;
    const noSpendDays = totalDays - spendDates.size;
    
    return `${noSpendDays}/${totalDays}`;
}
        
function renderSummaryData(periods) {
    if (periods.length === 0) {
        document.getElementById('summary-stats-cards').innerHTML = '<p style="text-align:center;color:var(--dark-gray);padding:var(--spacing-xl);">No data for selected filter üîç</p>';
        return;
    }
    
    // Calculate aggregate stats
    let totalSalary = 0, totalSpent = 0;
    let categoryTotals = { bills: 0, food: 0, wants: 0, oneOff: 0, unexpected: 0, savings: 0 };
    let paymentTotals = {};
    let allExpenses = [];
    let subcategoryTotals = {};

    periods.forEach(period => {
        const stats = calculatePeriodStats(period);
        totalSalary += period.salary || 0;
        totalSpent += stats.totalSpent;

        categoryTotals.bills += stats.categorySpending.bills;
        categoryTotals.food += stats.categorySpending.food;
        categoryTotals.wants += stats.categorySpending.wants;
        categoryTotals.oneOff += stats.categorySpending.oneOff;
        categoryTotals.unexpected += stats.categorySpending.unexpected;
        
        (period.expenses || []).forEach(expense => {
            const amount = (expense.myShare !== undefined && expense.myShare !== null) ? expense.myShare : expense.amount;
            if (expense.category !== 'Income') {
                allExpenses.push({...expense, amount, periodId: period.id});
                
                // Payment method totals
                if (expense.paymentMethod) {
                    paymentTotals[expense.paymentMethod] = (paymentTotals[expense.paymentMethod] || 0) + amount;
                }
                
                // Subcategory totals
                if (expense.subcategory) {
                    const key = `${expense.category} > ${expense.subcategory}`;
                    subcategoryTotals[key] = (subcategoryTotals[key] || 0) + amount;
                }
            }
        });
    });
    
    const totalSaved = totalSalary - totalSpent;
    categoryTotals.savings = totalSaved;
    const savingsRate = totalSalary > 0 ? (totalSaved / totalSalary) * 100 : 0;
    const avgDailySpend = allExpenses.length > 0 ? totalSpent / periods.length / 30 : 0;

    // Render summary cards
        document.getElementById('summary-stats-cards').innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:var(--spacing-md);margin-bottom:var(--spacing-lg);">
                <div class="summary-card" style="text-align:center;"><h3 style="color:var(--white);">üí∞ Total Salary</h3><div class="value">¬£${formatCurrency(totalSalary)}</div></div>
                <div class="summary-card" style="text-align:center;"><h3 style="color:var(--white);">üìä Total Spent</h3><div class="value">¬£${formatCurrency(totalSpent)}</div></div>
                <div class="summary-card" style="text-align:center;"><h3 style="color:var(--white);">üíé Total Saved</h3><div class="value">¬£${formatCurrency(totalSaved)}</div></div>
                <div class="summary-card" style="text-align:center;"><h3 style="color:var(--white);">üìà Savings Rate</h3><div class="value">${savingsRate.toFixed(1)}%</div></div>
                <div class="summary-card" style="text-align:center;"><h3 style="color:var(--white);">üìÖ Avg Daily</h3><div class="value">¬£${formatCurrency(avgDailySpend)}</div></div>
                <div class="summary-card" style="text-align:center;"><h3 style="color:var(--white);">üìÖ No Spend Days</h3><div class="value">${calculateNoSpendDays(periods)}</div></div>
            </div>
        `;
    
    // Render charts
    renderCategoryPieChart(categoryTotals);
    renderWeeklySpendingChart(periods);
    renderNetWorthChart(periods);
    renderSavingsRateChart(periods);
    renderDailySpendingChart(periods);
    renderTopExpensesTable(allExpenses);
    renderSubcategoryBreakdown(subcategoryTotals);
    renderPeriodComparisonTable(periods);
}

// Chart rendering functions
let categoryPieChart, paymentPieChart, networthChart, savingsRateChart, dailySpendingChart, periodDetailPieChart;

function renderCategoryPieChart(categoryTotals) {
    const ctx = document.getElementById('category-pie-chart');
    if (categoryPieChart) categoryPieChart.destroy();

    categoryPieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Bills', 'Food', 'Wants', 'One-off Needs', 'Unexpected', 'Savings'],
            datasets: [{
                data: [
                    categoryTotals.bills,
                    categoryTotals.food,
                    categoryTotals.wants,
                    categoryTotals.oneOff,
                    categoryTotals.unexpected,
                    categoryTotals.savings
                ],
                backgroundColor: ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', '#EF4444', '#22C55E'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a,b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ¬£' + formatCurrency(context.parsed) + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

function renderPeriodDetailPieChart(period) {
    const ctx = document.getElementById('period-detail-pie-chart');
    if (!ctx) return;
    if (periodDetailPieChart) periodDetailPieChart.destroy();

    const stats = calculatePeriodStats(period);
    const savings = (period.salary || 0) - stats.totalSpent;

    periodDetailPieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Bills', 'Food', 'Wants', 'One-off Needs', 'Unexpected', 'Savings'],
            datasets: [{
                data: [
                    stats.categorySpending.bills,
                    stats.categorySpending.food,
                    stats.categorySpending.wants,
                    stats.categorySpending.oneOff,
                    stats.categorySpending.unexpected,
                    savings
                ],
                backgroundColor: ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', '#EF4444', '#22C55E'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a,b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ¬£' + formatCurrency(context.parsed) + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

function renderPaymentPieChart(paymentTotals) {
    const ctx = document.getElementById('payment-pie-chart');
    if (paymentPieChart) paymentPieChart.destroy();
    
    const labels = Object.keys(paymentTotals);
    const data = Object.values(paymentTotals);
    const colors = ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', '#EF4444', '#6366F1'];
    
    paymentPieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a,b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ¬£' + formatCurrency(context.parsed) + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

function renderWeeklySpendingChart(periods) {
    const ctx = document.getElementById('weekly-spending-chart');
    if (!ctx) return;
    
    if (window.weeklySpendingChart) window.weeklySpendingChart.destroy();
    
    // Collect all expenses
    let allExpenses = [];
    periods.forEach(period => {
        (period.expenses || []).forEach(e => {
            if (e.category !== 'Income') {
                allExpenses.push({...e});
            }
        });
    });
    
    if (allExpenses.length === 0) return;
    
    // Group by week
    const weeklyData = {};
    allExpenses.forEach(expense => {
        const date = new Date(expense.date);
        const year = date.getFullYear();
        const week = getWeekNumber(date);
        const weekKey = `${year}-W${week}`;
        
        if (!weeklyData[weekKey]) {
            weeklyData[weekKey] = { bills: 0, wants: 0, food: 0, needs: 0, unexpected: 0 };
        }
        
        const amount = (expense.myShare !== undefined && expense.myShare !== null) ? expense.myShare : expense.amount;
        
        if (expense.category === 'Bills/Subscriptions') weeklyData[weekKey].bills += amount;
        else if (expense.category === 'Wants') weeklyData[weekKey].wants += amount;
        else if (expense.category === 'Food') weeklyData[weekKey].food += amount;
        else if (expense.category === 'One-off Needs') weeklyData[weekKey].needs += amount;
        else if (expense.category === 'Unexpected') weeklyData[weekKey].unexpected += amount;
    });
    
    const labels = Object.keys(weeklyData).sort();
    const datasets = [];
    
    if (document.getElementById('toggle-weekly-bills').checked) {
        datasets.push({
            label: 'Bills',
            data: labels.map(week => weeklyData[week].bills),
            backgroundColor: '#60A5FA'
        });
    }
    
    if (document.getElementById('toggle-weekly-wants').checked) {
        datasets.push({
            label: 'Wants',
            data: labels.map(week => weeklyData[week].wants),
            backgroundColor: '#A78BFA'
        });
    }
    
    if (document.getElementById('toggle-weekly-food').checked) {
        datasets.push({
            label: 'Food',
            data: labels.map(week => weeklyData[week].food),
            backgroundColor: '#34D399'
        });
    }
    
    if (document.getElementById('toggle-weekly-needs').checked) {
        datasets.push({
            label: 'Needs',
            data: labels.map(week => weeklyData[week].needs),
            backgroundColor: '#FBBF24'
        });
    }
    
    if (document.getElementById('toggle-weekly-unexpected').checked) {
        datasets.push({
            label: 'Unexpected',
            data: labels.map(week => weeklyData[week].unexpected),
            backgroundColor: '#F87171'
        });
    }
    
    window.weeklySpendingChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ¬£' + formatCurrency(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                x: { stacked: true },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '¬£' + value.toFixed(0);
                        }
                    }
                }
            }
        }
    });
}

function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
}

function renderNetWorthChart(periods) {
    const ctx = document.getElementById('networth-chart');
    if (networthChart) networthChart.destroy();

    const labels = periods.map(p => {
        const start = new Date(p.startDate);
        const end = new Date(p.endDate);
        const startMonth = start.toLocaleDateString('en-GB', { month: 'short' });
        const endMonth = end.toLocaleDateString('en-GB', { month: 'short' });
        return startMonth === endMonth ? startMonth : `${startMonth}-${endMonth}`;
    });

    const netWorthData = periods.map(p => {
        const sb = p.startingBalances || {};
        return calculateNetWorth(sb);
    });

    const netWorthOwedData = periods.map(p => {
        const sb = p.startingBalances || {};
        const netWorth = calculateNetWorth(sb);
        const totalOwed = (p.owedPeople || []).reduce((sum, person) => sum + (person.amount || 0), 0);
        return netWorth + totalOwed;
    });

    const datasets = [
        {
            label: 'Net Worth',
            data: netWorthData,
            borderColor: '#10B981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true
        },
        {
            label: 'Net Worth + Owed',
            data: netWorthOwedData,
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
        }
    ];

    networthChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ¬£' + formatCurrency(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            return '¬£' + value.toFixed(0);
                        }
                    }
                }
            }
        }
    });

    // Populate the table
    const tableBody = document.getElementById('networth-table-body');
    tableBody.innerHTML = periods.map((p, i) => {
        // Calculate monthly changes
        let nwChange = '';
        let nwOwedChange = '';

        if (i > 0) {
            // Net Worth change
            const nwDiff = netWorthData[i] - netWorthData[i - 1];
            const nwPercent = netWorthData[i - 1] !== 0 ? ((nwDiff / Math.abs(netWorthData[i - 1])) * 100) : 0;
            const nwSign = nwDiff >= 0 ? '+' : '';
            const nwColor = nwDiff >= 0 ? 'var(--success)' : 'var(--danger)';
            nwChange = `<span style="color:${nwColor};">${nwSign}¬£${formatCurrency(Math.abs(nwDiff))} (${nwSign}${nwPercent.toFixed(1)}%)</span>`;

            // Net Worth + Owed change
            const nwOwedDiff = netWorthOwedData[i] - netWorthOwedData[i - 1];
            const nwOwedPercent = netWorthOwedData[i - 1] !== 0 ? ((nwOwedDiff / Math.abs(netWorthOwedData[i - 1])) * 100) : 0;
            const nwOwedSign = nwOwedDiff >= 0 ? '+' : '';
            const nwOwedColor = nwOwedDiff >= 0 ? 'var(--success)' : 'var(--danger)';
            nwOwedChange = `<span style="color:${nwOwedColor};">${nwOwedSign}¬£${formatCurrency(Math.abs(nwOwedDiff))} (${nwOwedSign}${nwOwedPercent.toFixed(1)}%)</span>`;
        } else {
            nwChange = '<span style="color:var(--text-secondary);">-</span>';
            nwOwedChange = '<span style="color:var(--text-secondary);">-</span>';
        }

        return `
        <tr style="border-bottom:1px solid var(--light-gray);">
            <td style="padding:var(--spacing-sm);">${labels[i]}</td>
            <td style="padding:var(--spacing-sm); text-align:right; color:${netWorthData[i] >= 0 ? 'var(--success)' : 'var(--danger)'};">¬£${formatCurrency(netWorthData[i])}</td>
            <td style="padding:var(--spacing-sm); text-align:right; font-size:0.9em;">${nwChange}</td>
            <td style="padding:var(--spacing-sm); text-align:right; color:${netWorthOwedData[i] >= 0 ? 'var(--success)' : 'var(--danger)'};">¬£${formatCurrency(netWorthOwedData[i])}</td>
        </tr>
        `;
    }).reverse().join('');
}

function renderSavingsRateChart(periods) {
    const ctx = document.getElementById('savings-rate-chart');
    if (savingsRateChart) savingsRateChart.destroy();

    const labels = periods.map(p => formatDate(p.startDate));
    const savingsData = periods.map(p => {
        const stats = calculatePeriodStats(p);
        return stats.savingsRate;
    });

    savingsRateChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Savings Rate (%)',
                data: savingsData,
                backgroundColor: '#3B82F6',
                borderColor: '#1E40AF',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Savings Rate: ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });

    // Populate the table
    const tableBody = document.getElementById('savings-rate-table-body');
    tableBody.innerHTML = periods.map((p, i) => `
        <tr style="border-bottom:1px solid var(--light-gray);">
            <td style="padding:var(--spacing-sm);">${labels[i]}</td>
            <td style="padding:var(--spacing-sm); text-align:right;">${savingsData[i].toFixed(1)}%</td>
        </tr>
    `).reverse().join('');
}

function renderDailySpendingChart(periods) {
    const ctx = document.getElementById('daily-spending-chart');
    if (dailySpendingChart) dailySpendingChart.destroy();
    
    let allExpenses = [];
    periods.forEach(period => {
        (period.expenses || []).forEach(e => {
            if (e.category !== 'Income') {
                allExpenses.push({...e});
            }
        });
    });
    
    if (allExpenses.length === 0) return;
    
    const dates = allExpenses.map(e => new Date(e.date)).sort((a,b) => a - b);
    const minDate = dates[0];
    const maxDate = dates[dates.length - 1];
    
    const dailyData = {};
    allExpenses.forEach(expense => {
        const amount = (expense.myShare !== undefined && expense.myShare !== null) ? expense.myShare : expense.amount;
        const date = expense.date;
        
        if (!dailyData[date]) {
            dailyData[date] = { bills: 0, wants: 0, food: 0, needs: 0, unexpected: 0 };
        }

        if (expense.category === 'Bills/Subscriptions') dailyData[date].bills += amount;
        else if (expense.category === 'Wants') dailyData[date].wants += amount;
        else if (expense.category === 'Food') dailyData[date].food += amount;
        else if (expense.category === 'One-off Needs') dailyData[date].needs += amount;
        else if (expense.category === 'Unexpected') dailyData[date].unexpected += amount;
    });

    const labels = [];
    const currentDate = new Date(minDate);
    while (currentDate <= maxDate) {
        labels.push(formatDateForInput(currentDate));
        currentDate.setDate(currentDate.getDate() + 1);
    }

    const datasets = [];
    const isCumulative = document.getElementById('toggle-cumulative-summary').checked;

    function makeCumulative(data) {
        let cumSum = 0;
        return data.map(val => {
            cumSum += val;
            return cumSum;
        });
    }

    if (document.getElementById('toggle-bills-summary').checked) {
        const billsData = labels.map(date => dailyData[date]?.bills || 0);
        datasets.push({
            label: 'Bills/Subscriptions',
            data: isCumulative ? makeCumulative(billsData) : billsData,
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
        });
    }

    if (document.getElementById('toggle-wants-summary').checked) {
        const wantsData = labels.map(date => dailyData[date]?.wants || 0);
        datasets.push({
            label: 'Wants',
            data: isCumulative ? makeCumulative(wantsData) : wantsData,
            borderColor: '#8B5CF6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            tension: 0.4,
            fill: true
        });
    }

    if (document.getElementById('toggle-food-summary').checked) {
        const foodData = labels.map(date => dailyData[date]?.food || 0);
        datasets.push({
            label: 'Food',
            data: isCumulative ? makeCumulative(foodData) : foodData,
            borderColor: '#10B981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true
        });
    }

    if (document.getElementById('toggle-needs-summary').checked) {
        const needsData = labels.map(date => dailyData[date]?.needs || 0);
        datasets.push({
            label: 'One-off Needs',
            data: isCumulative ? makeCumulative(needsData) : needsData,
            borderColor: '#F59E0B',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            tension: 0.4,
            fill: true
        });
    }

    if (document.getElementById('toggle-unexpected-summary').checked) {
        const unexpectedData = labels.map(date => dailyData[date]?.unexpected || 0);
        datasets.push({
            label: 'Unexpected',
            data: isCumulative ? makeCumulative(unexpectedData) : unexpectedData,
            borderColor: '#EF4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.4,
            fill: true
        });
    }

    dailySpendingChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            }),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            onClick: (event, activeElements) => {
                if (activeElements.length > 0) {
                    const index = activeElements[0].index;
                    const clickedDate = labels[index];
                    console.log('Clicked on date:', clickedDate);
                    showDailySpendingDetails(clickedDate);
                }
            },
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ¬£' + formatCurrency(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '¬£' + value.toFixed(0);
                        }
                    }
                }
            }
        }
    });
}

function renderTopExpensesTable(allExpenses) {
    const tbody = document.getElementById('top-expenses-tbody');
    const filterSelect = document.getElementById('top-expenses-filter');
    
    if (!filterSelect._hasListener) {
        filterSelect.addEventListener('change', function() {
            const periods = getFilteredPeriods();
            let expenses = [];
            periods.forEach(period => {
                (period.expenses || []).forEach(e => {
                    if (e.category !== 'Income') {
                        const amount = (e.myShare !== undefined && e.myShare !== null) ? e.myShare : e.amount;
                        expenses.push({...e, amount});
                    }
                });
            });
            renderTopExpensesTable(expenses);
        });
        filterSelect._hasListener = true;
    }
    
    const filter = filterSelect.value;
    let filtered = allExpenses;
    
    if (filter !== 'all') {
        filtered = allExpenses.filter(e => e.category === filter);
    }
    
    const sorted = filtered.sort((a,b) => b.amount - a.amount).slice(0, 10);
    
    if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--dark-gray);padding:var(--spacing-lg);">No expenses found</td></tr>';
        return;
    }
    
    tbody.innerHTML = sorted.map(expense => `
        <tr>
            <td><strong>${formatDate(expense.date)}</strong></td>
            <td><strong>${escapeHtml(expense.description)}</strong></td>
            <td><span style="display:inline-block;padding:.35rem .75rem;border-radius:var(--radius-sm);background:var(--light-blue);font-weight:700;color:var(--primary-blue);">${expense.category}</span></td>
            <td><strong style="color:var(--danger);">¬£${formatCurrency(expense.amount)}</strong></td>
        </tr>
    `).join('');
}

function renderSubcategoryBreakdown(subcategoryTotals) {
    console.log('renderSubcategoryBreakdown called with:', subcategoryTotals);
    const container = document.getElementById('subcategory-breakdown');
    const sorted = Object.entries(subcategoryTotals).sort((a,b) => b[1] - a[1]);
    
    if (sorted.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--dark-gray);padding:var(--spacing-md);">No subcategory data available</p>';
        return;
    }
    
    container.innerHTML = sorted.map(([key, amount]) => {
        console.log('Creating row for subcategory:', key);
        // Create a safe ID for the key
        const safeId = key.replace(/[^a-zA-Z0-9]/g, '_');
        
        return `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:var(--spacing-sm); border-bottom:1px solid var(--medium-gray);">
            <span style="font-weight:600;">${escapeHtml(key)}</span>
            <span style="font-size:1.1rem; font-weight:700; color:var(--primary-blue); cursor:pointer; transition: color 0.2s;"
                  onmouseover="this.style.color='var(--dark-blue)'"
                  onmouseout="this.style.color='var(--primary-blue)'"
                  data-subcategory="${escapeHtml(key)}"
                  id="subcat-${safeId}">
                ¬£${formatCurrency(amount)} üîç
            </span>
        </div>
    `;
    }).join('');
    
    // Add click listeners after rendering
    console.log('Adding click listeners to subcategory rows');
    sorted.forEach(([key, amount]) => {
        const safeId = key.replace(/[^a-zA-Z0-9]/g, '_');
        const element = document.getElementById(`subcat-${safeId}`);
        if (element) {
            element.addEventListener('click', function() {
                console.log('Clicked on subcategory:', key);
                showSubcategoryTransactions(key);
            });
        } else {
            console.error('Could not find element for:', key);
        }
    });
}

function showSubcategoryTransactions(subcategoryKey) {
    console.log('showSubcategoryTransactions called with:', subcategoryKey);
    
    const parts = subcategoryKey.split(' > ');
    console.log('Split into parts:', parts);
    
    if (parts.length !== 2) {
        console.error('Invalid subcategory key format:', subcategoryKey);
        return;
    }
    
    const [category, subcategory] = parts;
    console.log('Category:', category, 'Subcategory:', subcategory);
    
    const periods = getFilteredPeriods();
    console.log('Filtered periods:', periods.length);
    
    let matchingExpenses = [];
    
    periods.forEach(period => {
        console.log('Checking period:', period.id, 'with', (period.expenses || []).length, 'expenses');
        (period.expenses || []).forEach(expense => {
            if (expense.category === category && expense.subcategory === subcategory && expense.category !== 'Income') {
                console.log('Found matching expense:', expense.description, expense.amount);
                const amount = (expense.myShare !== undefined && expense.myShare !== null) ? expense.myShare : expense.amount;
                matchingExpenses.push({
                    ...expense, 
                    amount,
                    periodStart: period.startDate
                });
            }
        });
    });
    
    console.log('Total matching expenses:', matchingExpenses.length);
    
    // Sort by date descending
    matchingExpenses.sort((a,b) => new Date(b.date) - new Date(a.date));
    
    document.getElementById('subcategory-modal-title').textContent = `Transactions: ${subcategoryKey} (${matchingExpenses.length} total)`;
    
    const tbody = document.getElementById('subcategory-transactions-tbody');
    
    if (matchingExpenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:var(--spacing-lg);color:var(--dark-gray);">No transactions found</td></tr>';
    } else {
        tbody.innerHTML = matchingExpenses.map(expense => `
            <tr>
                <td><strong>${formatDate(expense.date)}</strong></td>
                <td>
                    <strong>${escapeHtml(expense.description)}</strong>
                    ${expense.notes ? `<br><small style="color:var(--dark-gray);">${escapeHtml(expense.notes)}</small>` : ''}
                </td>
                <td><span style="display:inline-block;padding:.35rem .75rem;border-radius:var(--radius-sm);background:var(--light-blue);font-weight:700;color:var(--primary-blue);">${expense.category}</span></td>
                <td>${escapeHtml(expense.subcategory)}</td>
                <td><strong style="color:var(--danger);font-size:1.1rem;">¬£${formatCurrency(expense.amount)}</strong></td>
            </tr>
        `).join('');
    }
    
    console.log('Opening modal');
    openModal('subcategory-modal');
}

function showDailySpendingDetails(date) {
    console.log('showDailySpendingDetails called with:', date);

    const periods = getFilteredPeriods();
    console.log('Filtered periods:', periods.length);

    let matchingExpenses = [];

    periods.forEach(period => {
        (period.expenses || []).forEach(expense => {
            if (expense.date === date && expense.category !== 'Income') {
                console.log('Found matching expense:', expense.description, expense.amount);
                const amount = (expense.myShare !== undefined && expense.myShare !== null) ? expense.myShare : expense.amount;
                matchingExpenses.push({
                    ...expense,
                    amount,
                    periodStart: period.startDate
                });
            }
        });
    });

    console.log('Total matching expenses:', matchingExpenses.length);

    // Sort by amount descending (highest to lowest)
    matchingExpenses.sort((a,b) => b.amount - a.amount);

    const formattedDate = formatDate(date);
    document.getElementById('subcategory-modal-title').textContent = `Transactions on ${formattedDate} (${matchingExpenses.length} total)`;

    const tbody = document.getElementById('subcategory-transactions-tbody');

    if (matchingExpenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:var(--spacing-lg);color:var(--dark-gray);">No transactions found for this day</td></tr>';
    } else {
        tbody.innerHTML = matchingExpenses.map(expense => `
            <tr>
                <td><strong>${formatDate(expense.date)}</strong></td>
                <td>
                    <strong>${escapeHtml(expense.description)}</strong>
                    ${expense.notes ? `<br><small style="color:var(--dark-gray);">${escapeHtml(expense.notes)}</small>` : ''}
                </td>
                <td><span style="display:inline-block;padding:.35rem .75rem;border-radius:var(--radius-sm);background:var(--light-blue);font-weight:700;color:var(--primary-blue);">${expense.category}</span></td>
                <td>${escapeHtml(expense.subcategory)}</td>
                <td><strong style="color:var(--danger);font-size:1.1rem;">¬£${formatCurrency(expense.amount)}</strong></td>
            </tr>
        `).join('');
    }

    console.log('Opening modal');
    openModal('subcategory-modal');
}

function renderPeriodComparisonTable(periods) {
    const tbody = document.getElementById('period-comparison-tbody');

    tbody.innerHTML = periods.map(period => {
        const stats = calculatePeriodStats(period);
        const saved = (period.salary || 0) - stats.totalSpent;
        const sb = period.startingBalances || {};
        const netWorth = calculateNetWorth(sb);

        const start = new Date(period.startDate);
        const end = new Date(period.endDate);
        const startMonth = start.toLocaleDateString('en-GB', { month: 'short' });
        const endMonth = end.toLocaleDateString('en-GB', { month: 'short' });
        const dateLabel = startMonth === endMonth ? startMonth : `${startMonth}-${endMonth}`;

        return `
            <tr>
                <td><strong>${dateLabel}</strong></td>
                <td><strong>¬£${formatCurrency(stats.totalSpent)}</strong></td>
                <td><strong style="color:var(--success);">¬£${formatCurrency(saved)}</strong></td>
                <td><strong>${stats.savingsRate.toFixed(1)}%</strong></td>
                <td>¬£${formatCurrency(stats.categorySpending.bills)}</td>
                <td>¬£${formatCurrency(stats.categorySpending.food)}</td>
                <td>¬£${formatCurrency(stats.categorySpending.wants)}</td>
                <td><strong style="color:${netWorth >= 0 ? 'var(--success)' : 'var(--danger)'};">¬£${formatCurrency(netWorth)}</strong></td>
            </tr>
        `;
    }).reverse().join('');
}
        // ============================================
        // SUBCATEGORY MANAGEMENT
        // ============================================
        function renderSubcategoryManagement() {
            const container = document.getElementById('subcategory-management');
            const categories = Object.keys(subcategories);
            
            container.innerHTML = categories.map(category => `
                <div style="margin-bottom:var(--spacing-lg);">
                    <h4 style="color:var(--primary-blue);margin-bottom:var(--spacing-sm);">${category}</h4>
                    <div class="subcategory-list" id="subcats-${category.replace(/[^a-zA-Z]/g, '')}">
                        ${subcategories[category].map((sub, idx) => `
                            <span class="subcategory-chip">
                                ${escapeHtml(sub)}
                                <button onclick="removeSubcategory('${category}', ${idx})">√ó</button>
                            </span>
                        `).join('')}
                    </div>
                    <div class="inline-input">
                        <input type="text" id="new-subcat-${category.replace(/[^a-zA-Z]/g, '')}" placeholder="Add subcategory">
                        <button class="btn btn-sm btn-primary" onclick="addSubcategory('${category}')">Add</button>
                    </div>
                </div>
            `).join('');
        }

        function addSubcategory(category) {
            const inputId = 'new-subcat-' + category.replace(/[^a-zA-Z]/g, '');
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            
            if (!value) {
                alert('Please enter a subcategory name');
                return;
            }
            
            if (!subcategories[category]) {
                subcategories[category] = [];
            }
            
            if (subcategories[category].includes(value)) {
                alert('This subcategory already exists');
                return;
            }
            
            subcategories[category].push(value);
            saveSubcategories();
            input.value = '';
            renderSubcategoryManagement();
        }

        function removeSubcategory(category, index) {
            if (!confirm('Remove this subcategory?')) return;
            subcategories[category].splice(index, 1);
            saveSubcategories();
            renderSubcategoryManagement();
        }

        // Make functions globally accessible
        window.addSubcategory = addSubcategory;
        window.removeSubcategory = removeSubcategory;

        // ============================================
        // BANK ACCOUNT MANAGEMENT
        // ============================================
        function renderBankAccountManagement() {
            const container = document.getElementById('bank-account-management');

            container.innerHTML = bankAccounts.map((account, idx) => `
                <div class="subcategory-chip" style="margin:0.25rem;">
                    ${escapeHtml(account.name)}
                    <span style="font-size:0.8em; opacity:0.7;">(${account.type === 'debit' ? 'üí≥ Debit' : account.type === 'credit' ? 'üî¥ Credit' : 'üí∞ Loan'})</span>
                    <button onclick="removeBankAccount(${idx})">√ó</button>
                </div>
            `).join('');
        }

        function addBankAccount() {
            const nameInput = document.getElementById('new-account-name');
            const typeSelect = document.getElementById('new-account-type');
            const name = nameInput.value.trim();
            const type = typeSelect.value;

            if (!name) {
                alert('Please enter an account name');
                return;
            }

            // Check if account already exists
            if (bankAccounts.some(acc => acc.name === name)) {
                alert('An account with this name already exists');
                return;
            }

            // Generate a camelCase key from the name
            const key = name
                .replace(/[^a-zA-Z0-9\s]/g, '') // Remove special chars
                .split(' ')
                .map((word, idx) => {
                    word = word.toLowerCase();
                    return idx === 0 ? word : word.charAt(0).toUpperCase() + word.slice(1);
                })
                .join('');

            // Check if key already exists
            if (bankAccounts.some(acc => acc.key === key)) {
                alert('An account with a similar name already exists (key conflict)');
                return;
            }

            bankAccounts.push({ name, type, key });
            saveBankAccounts();
            nameInput.value = '';
            renderBankAccountManagement();
        }

        function removeBankAccount(index) {
            const account = bankAccounts[index];
            if (!confirm(`Remove ${account.name}? This will not delete existing data but the account will no longer be available.`)) return;
            bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccountManagement();
        }

        async function saveBankAccounts() {
            // Bank accounts are part of the full application state
            await saveAllDataToDatabase();
        }

        // Make functions globally accessible
        window.addBankAccount = addBankAccount;
        window.removeBankAccount = removeBankAccount;

        // ============================================
        // DYNAMIC FORM FIELD GENERATION
        // ============================================
        function renderStartingBalancesFields() {
            const container = document.getElementById('starting-balances-fields');
            if (!container) return;

            // Group accounts in rows of 3
            let html = '<div class="form-row">';
            bankAccounts.forEach((account, idx) => {
                if (idx > 0 && idx % 3 === 0) {
                    html += '</div><div class="form-row">';
                }
                const typeIcon = account.type === 'debit' ? 'üí≥' : account.type === 'credit' ? 'üî¥' : 'üí∞';
                html += `
                    <div class="form-group">
                        <label>${typeIcon} ${escapeHtml(account.name)}</label>
                        <input type="number" id="${account.key}" step="0.01" value="0" required>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function renderEditBalancesFields() {
            const container = document.getElementById('edit-balances-fields');
            if (!container) return;

            // Group accounts in rows of 3
            let html = '<div class="form-row">';
            bankAccounts.forEach((account, idx) => {
                if (idx > 0 && idx % 3 === 0) {
                    html += '</div><div class="form-row">';
                }
                const typeIcon = account.type === 'debit' ? 'üí≥' : account.type === 'credit' ? 'üî¥' : 'üí∞';
                html += `
                    <div class="form-group">
                        <label>${typeIcon} ${escapeHtml(account.name)}</label>
                        <input type="number" id="edit-${account.key}" step="0.01" value="0" required>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function getStartingBalancesFromForm() {
            const balances = {};
            bankAccounts.forEach(account => {
                const input = document.getElementById(account.key);
                balances[account.key] = input ? parseFloat(input.value || 0) : 0;
            });
            return balances;
        }

        function getStartingBalancesFromEditForm() {
            const balances = {};
            bankAccounts.forEach(account => {
                const input = document.getElementById(`edit-${account.key}`);
                balances[account.key] = input ? parseFloat(input.value || 0) : 0;
            });
            return balances;
        }

        // Populate payment method dropdown
        function populatePaymentMethods() {
            const select = document.getElementById('expense-payment');
            if (!select) return;

            // Clear existing options except the first one and Cash
            const options = select.querySelectorAll('option');
            options.forEach(opt => {
                if (opt.value !== '' && opt.value !== 'Cash') {
                    opt.remove();
                }
            });

            // Add bank accounts as options
            bankAccounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.name;
                option.textContent = account.name;
                select.insertBefore(option, select.querySelector('option[value="Cash"]'));
            });
        }

        // ============================================
        // DYNAMIC NET WORTH CALCULATIONS
        // ============================================
        function calculateTotalDebit(startingBalances) {
            let total = 0;
            bankAccounts.forEach(account => {
                if (account.type === 'debit') {
                    total += (startingBalances[account.key] || 0);
                }
            });
            return total;
        }

        function calculateTotalCredit(startingBalances) {
            let total = 0;
            bankAccounts.forEach(account => {
                if (account.type === 'credit' || account.type === 'loan') {
                    total += (startingBalances[account.key] || 0);
                }
            });
            return total;
        }

        function calculateNetWorth(startingBalances) {
            return calculateTotalDebit(startingBalances) - calculateTotalCredit(startingBalances);
        }

        // ============================================
        // EXPORT / IMPORT
        // ============================================
        function exportAllData() {
            const periods = getPeriods();
            const exportData = {
                periods: periods,
                subcategories: subcategories,
                bankAccounts: bankAccounts
            };
            const str = JSON.stringify(exportData, null, 2);
            const blob = new Blob([str], { type:'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `budget-tracker-backup-${formatDateForInput(new Date())}.json`;
            link.click();
        }

        function exportPeriodCSV() {
            const period = getPeriod(currentPeriodId);
            if (!period) { alert('Period not found!'); return; }
            let csv = 'Date,Description,Category,Subcategory,Amount,My Share,Payment Method,Notes\n';
            (period.expenses || []).forEach(expense => {
                csv += expense.date + ',';
                csv += '"' + (expense.description || '') + '",';
                csv += expense.category + ',';
                csv += (expense.subcategory || '') + ',';
                csv += expense.amount + ',';
                csv += (expense.myShare || '') + ',';
                csv += (expense.paymentMethod || '') + ',';
                csv += '"' + (expense.notes || '') + '"\n';
            });
            const blob = new Blob([csv], { type:'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `period-${formatDate(period.startDate)}-${formatDate(period.endDate)}.csv`;
            link.click();
        }

        function importAllData(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const imported = JSON.parse(evt.target.result);
                    if (!confirm('This will replace all existing data. Are you sure?')) return;
                    
                    // Handle different import formats
                    if (imported.periods) {
                        savePeriods(imported.periods);
                        if (imported.subcategories) {
                            subcategories = imported.subcategories;
                            saveSubcategories();
                        }
                        if (imported.bankAccounts) {
                            bankAccounts = imported.bankAccounts;
                            saveBankAccounts();
                        }
                    } else if (Array.isArray(imported)) {
                        // Old format - just periods array
                        savePeriods(imported);
                    } else {
                        alert('Unexpected JSON format');
                        return;
                    }
                    
                    loadPeriods();
                    alert('Data imported successfully! ‚úÖ');
                } catch (err) { alert('Error importing data: ' + err.message); }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (!confirm('This will delete ALL data permanently. Are you sure?')) return;
            if (!confirm('This cannot be undone! Really delete everything?')) return;
            localStorage.removeItem('budgetPeriods');
            localStorage.removeItem('budgetSubcategories');
            loadPeriods();
            alert('All data cleared! üóëÔ∏è');
        }

        // ============================================
        // UTILITY
        // ============================================
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            if (isNaN(d)) return dateStr;
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        function formatDateForInput(date) { return date.toISOString().split('T')[0]; }
        function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }
        function formatCurrency(value) {
            const num = parseFloat(value);
            if (isNaN(num)) return '0.00';
            if (Math.abs(num) > 999.99) {
                return num.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            return num.toFixed(2);
        }

        function updatePeriodInStorage(period) {
            const periods = getPeriods();
            const idx = periods.findIndex(p => p.id === period.id);
            if (idx !== -1) { periods[idx] = period; savePeriods(periods); } else {
                periods.push(period); savePeriods(periods);
            }
        }

                // --- NEW FUNCTION TO SAVE ALL DATA TO NETLIFY API ---
        async function saveAllDataToDatabase() {
            // 1. Compile the full state object from global variables
            const fullDataObject = {
                periods: periods, // Global 'periods' array
                subcategories: subcategories, // Global 'subcategories' object
                bankAccounts: bankAccounts // Global 'bankAccounts' array
            };
        
            try {
                const response = await fetch(API_SAVE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    // Send the entire combined object as the body
                    body: JSON.stringify(fullDataObject)
                });
        
                const result = await response.json();
        
                if (!response.ok) {
                    throw new Error(result.error || `HTTP error! Status: ${response.status}`);
                }
        
                console.log('Data successfully saved to the cloud! üéâ');
        
            } catch (error) {
                console.error("Error saving data to API:", error);
                alert('‚ö†Ô∏è Failed to save data. Please try again. See console for details.');
            }
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', function(){
            loadSubcategories(); // Load custom subcategories on startup
            
            document.getElementById('tab-home').addEventListener('click', () => showSection('home'));
            document.getElementById('tab-summary').addEventListener('click', () => showSection('summary'));
            document.getElementById('tab-settings').addEventListener('click', () => showSection('settings'));

            document.getElementById('btn-new-period').addEventListener('click', openNewPeriodModal);
            document.getElementById('btn-back-home').addEventListener('click', () => showSection('home'));
            document.getElementById('btn-add-expense').addEventListener('click', openAddExpenseModal);
            document.getElementById('btn-home-add-expense').addEventListener('click', () => {
                // Find the current period (most recent with days remaining >= 0)
                const periods = getPeriods();
                if (periods.length === 0) {
                    alert('Please create a period first! üöÄ');
                    return;
                }
                periods.sort((a,b) => new Date(b.startDate) - new Date(a.startDate));

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Find the first current period
                let currentActivePeriod = null;
                for (const period of periods) {
                    const endDate = new Date(period.endDate);
                    endDate.setHours(0, 0, 0, 0);
                    const daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));

                    if (daysRemaining >= 0) {
                        currentActivePeriod = period;
                        break;
                    }
                }

                if (!currentActivePeriod) {
                    alert('No active period found. Please create a new period! üìÖ');
                    return;
                }

                // Set as current period and open modal
                currentPeriod = currentActivePeriod;
                openAddExpenseModal();
            });
            document.getElementById('btn-edit-balances').addEventListener('click', openEditBalancesModal);
            document.getElementById('btn-export-csv').addEventListener('click', exportPeriodCSV);

            document.getElementById('close-subcategory-modal').addEventListener('click', () => closeModal('subcategory-modal'));

            document.getElementById('close-new-period').addEventListener('click', () => closeModal('new-period-modal'));
            document.getElementById('cancel-new-period').addEventListener('click', () => closeModal('new-period-modal'));
            document.getElementById('close-expense').addEventListener('click', () => closeModal('expense-modal'));
            document.getElementById('cancel-expense').addEventListener('click', () => closeModal('expense-modal'));
            document.getElementById('close-edit-balances').addEventListener('click', () => closeModal('edit-balances-modal'));
            document.getElementById('cancel-edit-balances').addEventListener('click', () => closeModal('edit-balances-modal'));

            document.getElementById('new-period-form').addEventListener('submit', createNewPeriod);
            document.getElementById('expense-form').addEventListener('submit', saveExpense);
            document.getElementById('edit-balances-form').addEventListener('submit', saveBalanceEdits);
            document.getElementById('expense-category').addEventListener('change', function(){
                updateSubcategories();
                const category = document.getElementById('expense-category').value;
                if (category === 'Income') document.getElementById('income-controls').style.display = 'flex';
                else document.getElementById('income-controls').style.display = 'none';
                populatePeopleAndSharedForPeriod();
            });

            document.getElementById('btn-export-all').addEventListener('click', async () => {
                showMessage('Saving all data to database... please wait.', 'info');
                // This is the explicit user action to commit changes
                await saveAllDataToDatabase(); 
                showMessage('Data successfully saved to the cloud! ‚úÖ', 'success');
            });

            document.getElementById('btn-save-cloud').addEventListener('click', async () => {
                const saveBtn = document.getElementById('btn-save-cloud');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '‚è≥ Saving...';
                saveBtn.disabled = true;
                
                await saveAllDataToDatabase();
                
                saveBtn.innerHTML = '‚úÖ Saved!';
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }, 2000);
            });

            document.getElementById('btn-import-trigger').addEventListener('click', () => {
                // Re-run the initial loader to pull fresh data from the DB
                initializeDataFromDatabase();
                showMessage('Data import triggered. Reloading all data from the database.', 'info');
            });
            document.getElementById('import-file').addEventListener('change', importAllData);
            document.getElementById('btn-clear-all').addEventListener('click', clearAllData);

            loadPeriods();

            const periods = getPeriods();
            if (periods.length === 1) viewPeriod(periods[0].id);

            document.addEventListener('click', function(evt){
                if (evt.target && evt.target.matches('[data-edit-expense]')) editExpense(evt.target.dataset.editExpense);
                if (evt.target && evt.target.matches('[data-delete-expense]')) deleteExpense(evt.target.dataset.deleteExpense);
            });
        });


        // Chart variable
let spendingChart = null;

// Add to the end of loadFullSummary() function
function initializeSpendingChart() {
    const periods = getPeriods();
    let allExpenses = [];
    periods.forEach(period => {
        if (period.expenses) {
            allExpenses = allExpenses.concat(period.expenses.map(e => ({...e})));
        }
    });
    document.getElementById('toggle-cumulative').addEventListener('change', renderSpendingChart);

    if (allExpenses.length === 0) return;

    const dates = allExpenses.map(e => new Date(e.date)).sort((a,b) => a - b);
    const minDate = dates[0];
    const maxDate = dates[dates.length - 1];

    document.getElementById('chart-start-date').value = formatDateForInput(minDate);
    document.getElementById('chart-end-date').value = formatDateForInput(maxDate);

    renderSpendingChart();

    document.getElementById('update-chart-range').addEventListener('click', renderSpendingChart);
    ['toggle-bills', 'toggle-wants', 'toggle-food', 'toggle-needs', 'toggle-income', 'toggle-unexpected'].forEach(id => {
        document.getElementById(id).addEventListener('change', renderSpendingChart);
    });
    ['toggle-networth', 'toggle-networth-owed'].forEach(id => {
    document.getElementById(id).addEventListener('change', () => renderNetWorthChart(getFilteredPeriods()));
    });
}

function renderSpendingChart() {
    const startDate = new Date(document.getElementById('chart-start-date').value);
    const endDate = new Date(document.getElementById('chart-end-date').value);
    
    const periods = getPeriods();
    let allExpenses = [];
    periods.forEach(period => {
        if (period.expenses) {
            allExpenses = allExpenses.concat(period.expenses.map(e => ({...e})));
        }
    });

    allExpenses = allExpenses.filter(e => {
        const expDate = new Date(e.date);
        return expDate >= startDate && expDate <= endDate;
    });

    const dailyData = {};
    allExpenses.forEach(expense => {
        const amount = (expense.myShare !== undefined && expense.myShare !== null) ? expense.myShare : expense.amount;
        const date = expense.date;
        
        if (!dailyData[date]) {
            dailyData[date] = { bills: 0, wants: 0, food: 0, needs: 0, income: 0, unexpected: 0 };
        }

        if (expense.category === 'Bills/Subscriptions') dailyData[date].bills += amount;
        else if (expense.category === 'Wants') dailyData[date].wants += amount;
        else if (expense.category === 'Food') dailyData[date].food += amount;
        else if (expense.category === 'One-off Needs') dailyData[date].needs += amount;
        else if (expense.category === 'Income') dailyData[date].income += amount;
        else if (expense.category === 'Unexpected') dailyData[date].unexpected += amount;
    });

    const labels = [];
    const currentDate = new Date(startDate);
    while (currentDate <= endDate) {
        labels.push(formatDateForInput(currentDate));
        currentDate.setDate(currentDate.getDate() + 1);
    }

    const datasets = [];
    const isCumulative = document.getElementById('toggle-cumulative').checked;

    // Helper function to create cumulative data
    function makeCumulative(data) {
        let cumSum = 0;
        return data.map(val => {
            cumSum += val;
            return cumSum;
        });
    }

    if (document.getElementById('toggle-bills').checked) {
        const billsData = labels.map(date => dailyData[date]?.bills || 0);
        datasets.push({
            label: 'Bills/Subscriptions',
            data: isCumulative ? makeCumulative(billsData) : billsData,
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
        });
    }

    if (document.getElementById('toggle-wants').checked) {
        const wantsData = labels.map(date => dailyData[date]?.wants || 0);
        datasets.push({
            label: 'Wants',
            data: isCumulative ? makeCumulative(wantsData) : wantsData,
            borderColor: '#8B5CF6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            tension: 0.4,
            fill: true
        });
    }

    if (document.getElementById('toggle-food').checked) {
        const foodData = labels.map(date => dailyData[date]?.food || 0);
        datasets.push({
            label: 'Food',
            data: isCumulative ? makeCumulative(foodData) : foodData,
            borderColor: '#10B981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true
        });
    }

    if (document.getElementById('toggle-needs').checked) {
        const needsData = labels.map(date => dailyData[date]?.needs || 0);
        datasets.push({
            label: 'One-off Needs',
            data: isCumulative ? makeCumulative(needsData) : needsData,
            borderColor: '#F59E0B',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            tension: 0.4,
            fill: true
        });
    }

    if (document.getElementById('toggle-income').checked) {
        const incomeData = labels.map(date => dailyData[date]?.income || 0);
        datasets.push({
            label: 'Income',
            data: isCumulative ? makeCumulative(incomeData) : incomeData,
            borderColor: '#059669',
            backgroundColor: 'rgba(5, 150, 105, 0.1)',
            tension: 0.4,
            fill: true
        });
    }

    if (document.getElementById('toggle-unexpected').checked) {
        const unexpectedData = labels.map(date => dailyData[date]?.unexpected || 0);
        datasets.push({
            label: 'Unexpected',
            data: isCumulative ? makeCumulative(unexpectedData) : unexpectedData,
            borderColor: '#EF4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.4,
            fill: true
        });
    }

    if (spendingChart) {
        spendingChart.destroy();
    }

    const ctx = document.getElementById('spending-chart').getContext('2d');
    spendingChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            }),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ¬£' + formatCurrency(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '¬£' + value.toFixed(0);
                        }
                    }
                }
            }
        }
    });
}

function setChartRange(range) {
    const endDate = new Date();
    let startDate = new Date();

    if (range === 'week') {
        startDate.setDate(endDate.getDate() - 7);
    } else if (range === 'month') {
        startDate.setMonth(endDate.getMonth() - 1);
    } else if (range === 'all') {
        const periods = getPeriods();
        let allExpenses = [];
        periods.forEach(period => {
            if (period.expenses) {
                allExpenses = allExpenses.concat(period.expenses);
            }
        });
        if (allExpenses.length > 0) {
            const dates = allExpenses.map(e => new Date(e.date)).sort((a,b) => a - b);
            startDate = dates[0];
            endDate = dates[dates.length - 1];
        }
    }

    document.getElementById('chart-start-date').value = formatDateForInput(startDate);
    document.getElementById('chart-end-date').value = formatDateForInput(endDate);
    renderSpendingChart();
}

window.setChartRange = setChartRange;
        
       // --- END NEW FUNCTION ---
        
    </script>
</body>
</html>
